<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch.Right.Android - Story Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }
        
        .screen.active {
            opacity: 1;
        }
        
        .content-box {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        
        h1, h2 {
            color: #ffd700;
            margin-bottom: 20px;
        }
        
        button {
            background: #ffd700;
            color: #333;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #ffed4e;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .video-container {
            width: 100%;
            max-width: 500px;
            margin: 20px 0;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            resize: none;
            margin: 20px 0;
            box-sizing: border-box;
        }
        
        .pause-prompt {
            background: rgba(255, 215, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            margin: 20px 0;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            animation: slideIn 0.5s ease-out;
            cursor: pointer;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .editor-response {
            background: rgba(147, 51, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #ffd700;
            text-align: left;
        }
        
        .character-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 18px;
        }
        
        .story-display {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timer {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 25px;
            font-family: monospace;
            font-size: 18px;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.3);
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            color: #fff;
        }

        .success-message {
            background: rgba(40, 167, 69, 0.3);
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            color: #fff;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="screen active" id="welcomeScreen">
        <div class="content-box">
            <h1>‚ú® Story Creator ‚ú®</h1>
            <p>Watch a magical video and help create an amazing story!</p>
            <button id="startButton">Start Your Story Adventure! üöÄ</button>
            
            <!-- Connection status indicator -->
            <div id="connectionStatus" style="margin-top: 20px; font-size: 14px; opacity: 0.7;"></div>
        </div>
    </div>

    <!-- Video Watching Screen -->
    <div class="screen" id="videoScreen">
        <div class="timer" id="timer">00:00</div>
        <div class="content-box">
            <h2>üì∫ Let's Watch Together!</h2>
            <div class="video-container">
                <iframe id="videoPlayer" width="100%" height="315" 
                        src="https://www.youtube.com/embed/ScMzIvxBSi4" 
                        frameborder="0" allowfullscreen></iframe>
            </div>
            <div id="pausePrompt" class="pause-prompt" style="display:none;">
                <h3>‚úã Pause Time!</h3>
                <p id="pauseQuestion">What just happened in the story?</p>
                <textarea id="storyInput" placeholder="Tell me what you saw..."></textarea>
                <button id="continueButton">Continue Watching ‚ñ∂Ô∏è</button>
                <button id="finishButton">I'm Done Writing! ‚úÖ</button>
            </div>
        </div>
    </div>

    <!-- Story Review Screen -->
    <div class="screen" id="reviewScreen">
        <div class="content-box">
            <h2>üìñ Your Amazing Story!</h2>
            <div id="fullStory" class="story-display"></div>
            <p>Ready to send your story to our magical editor?</p>
            <button id="sendEditorButton">Send to Editor üìÆ</button>
        </div>
    </div>

    <!-- Waiting for Editor Screen -->
    <div class="screen" id="waitingScreen">
        <div class="content-box">
            <h2>üßô‚Äç‚ôÇÔ∏è Editor is Working Magic...</h2>
            <p>Grammaticus is reading your story and preparing helpful suggestions!</p>
            <div style="font-size: 3em; animation: spin 2s linear infinite;">‚è≥</div>
            <p><small>This usually takes a few moments...</small></p>
        </div>
    </div>

    <!-- Editor Response Screen -->
    <div class="screen" id="editorScreen">
        <div class="content-box">
            <h2>üì¨ Message from Your Editor!</h2>
            <div id="editorResponse" class="editor-response"></div>
            <h3>Your Story (you can edit it):</h3>
            <textarea id="editStory" placeholder="Edit your story here..."></textarea>
            <button id="submitRevisionButton">Send Back to Editor üìù</button>
            <button id="finalizeButton">My Story is Perfect! ‚≠ê</button>
        </div>
    </div>

    <!-- Final Success Screen -->
    <div class="screen" id="successScreen">
        <div class="content-box">
            <h1>üéâ Congratulations!</h1>
            <p>You've created an amazing story! Your writing skills are getting stronger every day.</p>
            <div id="finalStory" class="story-display"></div>
            <button id="newStoryButton">Create Another Story! üîÑ</button>
        </div>
    </div>

    <script>
        // Story session data
        let storyParts = [];
        let currentVideoTime = 0;
        let pauseTimes = [15, 45, 75, 105]; // YOU CAN CHANGE THESE PAUSE TIMES
        let currentPauseIndex = 0;
        let sessionStartTime = Date.now();
        let timerInterval;
        
        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        // Timer
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        // Story session flow
        function startStorySession() {
            console.log("Starting story session...");
            showScreen('videoScreen');
            startTimer();
            
            // Fix interaction issues
            fixInteractionIssues();
            
            // Simulate video pause points
            setTimeout(() => pauseVideo(), pauseTimes[0] * 1000);
        }
        
        // Fix for interaction blocking issues
        function fixInteractionIssues() {
            // Fix iframe pointer events
            document.querySelectorAll('iframe').forEach(iframe => {
                iframe.style.pointerEvents = 'auto';
                iframe.style.zIndex = '1';
            });
            
            // Ensure pause prompt is interactive
            const pausePrompt = document.getElementById('pausePrompt');
            if (pausePrompt) {
                pausePrompt.style.pointerEvents = 'auto';
                pausePrompt.style.zIndex = '999';
                pausePrompt.style.position = 'relative';
            }
            
            // Fix all buttons and textareas
            document.querySelectorAll('button, textarea').forEach(element => {
                element.style.pointerEvents = 'auto';
                element.style.zIndex = '100';
                element.style.position = 'relative';
            });
        }
        
        function pauseVideo() {
            console.log("Pausing video...");
            
            const questions = [
                "What happened in the beginning of the story?",
                "Who are the main characters and what are they doing?",
                "What problem or challenge appeared?",
                "How do you think the story will end?"
            ];
            
            document.getElementById('pauseQuestion').textContent = 
                questions[currentPauseIndex] || "What just happened?";
            
            const pausePrompt = document.getElementById('pausePrompt');
            pausePrompt.style.display = 'block';
            
            // Re-apply fixes when showing pause prompt
            fixInteractionIssues();
            
            // Focus on textarea to ensure it's interactive
            setTimeout(() => {
                document.getElementById('storyInput').focus();
            }, 100);
        }
        
        function continueVideo() {
            const storyPart = document.getElementById('storyInput').value.trim();
            if (storyPart) {
                storyParts.push(storyPart);
                document.getElementById('storyInput').value = '';
                document.getElementById('pausePrompt').style.display = 'none';
                
                currentPauseIndex++;
                if (currentPauseIndex < pauseTimes.length) {
                    const nextPause = pauseTimes[currentPauseIndex] - pauseTimes[currentPauseIndex - 1];
                    setTimeout(() => pauseVideo(), nextPause * 1000);
                } else {
                    // Video finished
                    setTimeout(() => {
                        pauseVideo();
                        document.getElementById('pauseQuestion').textContent = "How did the story end?";
                    }, 30000); // 30 seconds to finish video
                }
            } else {
                alert('Please write something about what happened!');
            }
        }
        
        function finishStory() {
            const finalPart = document.getElementById('storyInput').value.trim();
            if (finalPart) {
                storyParts.push(finalPart);
            }
            
            if (storyParts.length === 0) {
                alert('Please write at least one part of the story!');
                return;
            }
            
            stopTimer();
            displayFullStory();
            showScreen('reviewScreen');
        }
        
        function displayFullStory() {
            const fullStory = storyParts.join(' ');
            document.getElementById('fullStory').textContent = fullStory;
            document.getElementById('editStory').value = fullStory;
            document.getElementById('finalStory').textContent = fullStory;
        }
        
        async function sendToEditor() {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            showScreen('waitingScreen');
            
            try {
                const fullStory = storyParts.join(' ');
                const editorResponse = await callGeminiAPI(fullStory, 'editor');
                
                document.getElementById('editorResponse').innerHTML = `
                    <div class="character-name">üßô‚Äç‚ôÇÔ∏è Grammaticus says:</div>
                    <p>${editorResponse}</p>
                `;
                
                // Show notification
                showNotification('üì¨ You have a message from your editor!');
                
                setTimeout(() => showScreen('editorScreen'), 2000);
                
            } catch (error) {
                console.error('Editor API Error:', error);
                showError(`Editor is busy right now: ${error.message}`);
                showScreen('reviewScreen');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send to Editor üìÆ';
            }
        }
        
        async function submitRevision() {
            const revisedStory = document.getElementById('editStory').value;
            
            if (!revisedStory.trim()) {
                alert('Please write your story before sending it back!');
                return;
            }
            
            showScreen('waitingScreen');
            
            try {
                const feedback = await callGeminiAPI(revisedStory, 'revision');
                
                document.getElementById('editorResponse').innerHTML = `
                    <div class="character-name">üßô‚Äç‚ôÇÔ∏è Grammaticus says:</div>
                    <p>${feedback}</p>
                `;
                
                showNotification('üì¨ Your editor responded!');
                setTimeout(() => showScreen('editorScreen'), 2000);
                
            } catch (error) {
                console.error('Revision API Error:', error);
                showError(`Editor is busy: ${error.message}`);
                showScreen('editorScreen');
            }
        }
        
        function finalizeStory() {
            const finalStory = document.getElementById('editStory').value;
            document.getElementById('finalStory').textContent = finalStory;
            showScreen('successScreen');
        }
        
        function startNewStory() {
            // Reset everything
            storyParts = [];
            currentPauseIndex = 0;
            sessionStartTime = Date.now();
            document.getElementById('storyInput').value = '';
            document.getElementById('editStory').value = '';
            document.getElementById('pausePrompt').style.display = 'none';
            showScreen('welcomeScreen');
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.onclick = () => notification.remove();
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>Oops!</strong> ${message}`;
            document.querySelector('.content-box').appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<strong>Success!</strong> ${message}`;
            document.querySelector('.content-box').appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 5000);
        }
        
        // SECURE API CALL TO YOUR SERVER
        async function callGeminiAPI(storyText, mode) {
            let prompt;
            if (mode === 'editor') {
                prompt = `You are Grammaticus, a magical writing editor who helps children improve their stories. A child just wrote this story after watching a video: "${storyText}"

Respond as a friendly editor with:
1. Specific praise for what they did well
2. 2-3 gentle suggestions to make it even better
3. Ask one question to help them think deeper
4. Keep it encouraging and under 80 words
5. Use magical, playful language

Be like a wise, kind teacher who makes writing fun!`;
            } else {
                prompt = `You are Grammaticus responding to a child's revised story. Original story: "${storyParts.join(' ')}" 
Revised version: "${storyText}"

Give encouraging feedback on their improvements and either:
- Suggest one final small enhancement, OR
- Congratulate them on their excellent work if it's ready

Keep it brief, magical, and supportive (under 60 words).`;
            }
            
            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 150
                }
            };
            
            console.log('Calling API with:', requestBody);
            
            const response = await fetch('/api/editor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('API response:', data);
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Invalid response from AI service');
            }
            
            return data.candidates[0].content.parts[0].text;
        }
        
        // Test server connection on load
        window.addEventListener('load', async () => {
            const statusElement = document.getElementById('connectionStatus');
            
            try {
                console.log('Testing server connection...');
                const response = await fetch('/health');
                const data = await response.json();
                console.log('‚úÖ Server connection OK:', data);
                
                statusElement.innerHTML = `<span style="color: #28a745;">‚úÖ Server Ready</span>`;
                statusElement.classList.add('success-message');
                
            } catch (error) {
                console.error('‚ùå Server connection failed:', error);
                statusElement.innerHTML = `<span style="color: #dc3545;">‚ùå Server connection issue</span>`;
                statusElement.classList.add('error-message');
            }
            
            // Add proper event listeners to fix button issues
            setupEventListeners();
        });
        
        // Setup proper event listeners
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // Main start button
            const startButton = document.getElementById('startButton');
            if (startButton) {
                startButton.addEventListener('click', function(e) {
                    console.log("Start button clicked!");
                    e.preventDefault();
                    startStorySession();
                });
                console.log("Start button listener added");
            }
            
            // Continue and finish buttons
            const continueButton = document.getElementById('continueButton');
            const finishButton = document.getElementById('finishButton');
            
            if (continueButton) {
                continueButton.addEventListener('click', function(e) {
                    console.log("Continue button clicked!");
                    e.preventDefault();
                    continueVideo();
                });
            }
            
            if (finishButton) {
                finishButton.addEventListener('click', function(e) {
                    console.log("Finish button clicked!");
                    e.preventDefault();
                    finishStory();
                });
            }
            
            // Send to editor button
            const sendEditorButton = document.getElementById('sendEditorButton');
            if (sendEditorButton) {
                sendEditorButton.addEventListener('click', function(e) {
                    console.log("Send to editor clicked!");
                    e.preventDefault();
                    sendToEditor();
                });
            }
            
            // Submit revision button
            const submitRevisionButton = document.getElementById('submitRevisionButton');
            if (submitRevisionButton) {
                submitRevisionButton.addEventListener('click', function(e) {
                    console.log("Submit revision clicked!");
                    e.preventDefault();
                    submitRevision();
                });
            }
            
            // Finalize button
            const finalizeButton = document.getElementById('finalizeButton');
            if (finalizeButton) {
                finalizeButton.addEventListener('click', function(e) {
                    console.log("Finalize clicked!");
                    e.preventDefault();
                    finalizeStory();
                });
            }
            
            // New story button
            const newStoryButton = document.getElementById('newStoryButton');
            if (newStoryButton) {
                newStoryButton.addEventListener('click', function(e) {
                    console.log("New story clicked!");
                    e.preventDefault();
                    startNewStory();
                });
            }
            
            // Make all buttons visually clickable
            document.querySelectorAll('button').forEach(button => {
                button.style.pointerEvents = 'auto';
                button.style.zIndex = '999';
                button.style.position = 'relative';
                button.style.cursor = 'pointer';
                
                // Add hover effect
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.backgroundColor = '#ffed4e';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.backgroundColor = '#ffd700';
                });
            });
            
            // Fix textareas
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.style.pointerEvents = 'auto';
                textarea.style.zIndex = '100';
                textarea.style.position = 'relative';
            });
            
            console.log("All event listeners set up!");
        }
        
        // Debug log
        console.log('üé¨ Story Creator app loaded successfully!');
    </script>
</body>
</html>