<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryForge - Where Stories Are Forged, Not Just Written</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            color: #1f2937;
            min-height: 100vh;
        }

        .page {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .page.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }

        .wide-card {
            max-width: 1200px;
        }

        h1 {
            color: #1e40af;
            text-align: center;
            margin-bottom: 16px;
            font-size: 2.5rem;
        }

        h2 {
            color: #1e40af;
            text-align: center;
            margin-bottom: 16px;
            font-size: 1.8rem;
        }

        .subtitle {
            text-align: center;
            color: #4b5563;
            margin-bottom: 24px;
            font-size: 1.1rem;
        }

        .tagline {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 32px;
            font-size: 1rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            margin-bottom: 16px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        button {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .video-writing-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .video-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .writing-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .ai-response {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .ai-character {
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .story-display {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            line-height: 1.8;
            font-size: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .story-display p {
            margin-bottom: 16px;
            text-indent: 20px;
        }

        .story-display p:first-child {
            text-indent: 0;
            font-weight: bold;
            color: #1e40af;
        }

        .story-library {
            margin-top: 20px;
        }

        .story-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .story-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .story-title {
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .story-date {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading::after {
            content: "‚ö°";
            animation: spin 1s linear infinite;
            font-size: 2rem;
            display: block;
            margin: 20px auto;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
            margin-bottom: 0;
        }

        .secondary-button {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .success-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .character-badge {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .book-page {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .book-page img {
            width: 100%;
            max-width: 400px;
            height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .book-page .page-text {
            font-size: 18px;
            line-height: 1.6;
            color: #374151;
            max-width: 500px;
            margin: 0 auto;
            text-align: left;
        }

        .book-page .page-number {
            color: #6b7280;
            font-size: 14px;
            margin-top: 16px;
            text-align: center;
        }

        .image-error {
            width: 100%;
            max-width: 400px;
            height: 400px;
            background: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 16px;
            color: #6b7280;
        }

        .image-error .error-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .book-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
            .video-writing-container {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Page -->
    <div id="welcomePage" class="page active">
        <div class="card">
            <h1>üè∞ Welcome to StoryForge</h1>
            <p class="tagline">Where Stories Are Forged, Not Just Written</p>
            <p class="subtitle">Welcome, future Intern! The Storymakers Guild is ready to help you forge your first epic tale.</p>
            <input type="text" id="nameInput" placeholder="What should we call you, brave storyteller?" maxlength="50">
            <button id="beginAdventure">Begin My Adventure</button>
        </div>
    </div>

    <!-- Workshop Page -->
    <div id="workshopPage" class="page">
        <div class="card wide-card">
            <h2>‚ö° StoryForge Workshop</h2>
            <p class="subtitle">Welcome, <span id="userName">Intern</span>! Watch this video and write your story alongside it. Your Editor is standing by to help.</p>
            
            <div class="video-writing-container">
                <div class="video-section">
                    <h3>üì∫ Your Story Inspiration</h3>
                    <div class="video-container">
                        <iframe id="videoPlayer" 
                                src="https://www.youtube.com/embed/OvOrbWggMTs" 
                                allowfullscreen>
                        </iframe>
                    </div>
                    <p style="margin-top: 12px; color: #6b7280; text-align: center;">
                        Watch and write! You can pause, rewind, or replay anytime.
                    </p>
                </div>
                
                <div class="writing-section">
                    <h3>‚úçÔ∏è Your Story</h3>
                    <textarea id="storyInput" 
                              placeholder="Start writing your story as you watch the video. What do you see happening? Who are the characters? What's the adventure about?"></textarea>
                    <div class="button-group">
                        <button id="getEditorFeedback">Get Editor Feedback</button>
                        <button id="backToDashboard" class="secondary-button">Back to Library</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Editor Feedback Page -->
    <div id="editorPage" class="page">
        <div class="card wide-card">
            <h2>üìù Editor Feedback</h2>
            
            <div id="editorResponse" class="ai-response">
                <div class="loading">Your Editor is reviewing your story...</div>
            </div>
            
            <h3>Your Story (feel free to revise):</h3>
            <textarea id="editableStory" placeholder="Revise your story based on the Editor's suggestions..."></textarea>
            
            <div class="button-group" id="editorButtons">
                <button id="submitRevision">Submit Revision</button>
                <button id="acceptStory" class="success-button">This is Good!</button>
            </div>
        </div>
    </div>

    <!-- Guild Collaboration Page -->
    <div id="guildPage" class="page">
        <div class="card wide-card">
            <h2>üèõÔ∏è Guild Collaboration</h2>
            
            <div id="guildIntro" class="ai-response">
                <div class="character-badge">Editor</div>
                <p>Excellent work, Intern! Your story has caught the attention of another writer in the Guild who would love to create their own version based on your amazing idea. Would you be willing to give them feedback on their interpretation?</p>
            </div>
            
            <div class="button-group" id="guildChoice">
                <button id="allowCollaboration" class="success-button">Yes, I'd love to help!</button>
                <button id="declineCollaboration" class="secondary-button">No thanks, I'm done</button>
            </div>
            
            <div id="guildStorySection" style="display: none;">
                <h3>üìñ The Guild Writer's Version:</h3>
                <div id="guildStory" class="story-display">
                    <div class="loading">The Guild writer is crafting their version...</div>
                </div>
                
                <h3>Your Feedback:</h3>
                <textarea id="feedbackInput" placeholder="What do you think of this version? Any suggestions for the writer?"></textarea>
                
                <div class="button-group" id="feedbackButtons">
                    <button id="submitFeedback">Send Feedback</button>
                    <button id="approveFinalStory" class="success-button">It's Perfect!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Final Success Page -->
    <div id="successPage" class="page">
        <div class="card">
            <h1>üéâ Story Complete!</h1>
            <p class="subtitle">The Guild writer was actually... StoryForge helping bring your story to life!</p>
            
            <h3>Your Final Story:</h3>
            <div id="finalStory" class="story-display"></div>
            
            <h3>Give your story a title:</h3>
            <input type="text" id="storyTitle" placeholder="Enter your story title..." maxlength="100">
            
            <div class="button-group">
                <button id="saveStory" class="success-button">Save to Library</button>
                <button id="downloadStory" class="secondary-button">Download Story</button>
            </div>
            
            <div class="ai-response" style="text-align: center; margin: 20px 0;">
                <div class="character-badge">üé® The Press</div>
                <p>Would you like to bring this story to life with beautiful illustrations? We can create a full picture book for you!</p>
                <button id="createIllustratedBook" style="margin: 10px auto; width: auto; padding: 12px 24px;">
                    ‚ú® Create Illustrated Book
                </button>
            </div>
            
            <div class="button-group">
                <button id="createAnother">Forge Another Story</button>
                <button id="viewLibrary" class="secondary-button">View Library</button>
            </div>
        </div>
    </div>

    <!-- Illustrated Book Page -->
    <div id="illustratedBookPage" class="page">
        <div class="card wide-card">
            <h2>üìñ Your Illustrated Story</h2>
            <p class="subtitle" id="bookTitle">Loading your beautiful picture book...</p>
            
            <div id="bookLoadingSection">
                <div class="ai-response">
                    <div class="character-badge">üé® The Press</div>
                    <div id="bookProgress">
                        <div class="loading">Creating your illustrated masterpiece...</div>
                        <p id="progressText">Analyzing characters and scenes...</p>
                    </div>
                </div>
            </div>
            
            <div id="bookDisplaySection" style="display: none;">
                <div class="book-controls" style="text-align: center; margin-bottom: 20px;">
                    <button id="prevPage" class="secondary-button" style="width: auto; margin: 0 10px;">‚Üê Previous</button>
                    <span id="pageCounter" style="margin: 0 20px; font-weight: bold;">Page 1 of 12</span>
                    <button id="nextPage" class="secondary-button" style="width: auto; margin: 0 10px;">Next ‚Üí</button>
                </div>
                
                <div class="book-page" id="bookPageDisplay">
                    <!-- Individual pages will be inserted here -->
                </div>
                
                <div class="button-group" style="margin-top: 30px;">
                    <button id="downloadIllustratedBook" class="success-button">Download Picture Book</button>
                    <button id="backToStory" class="secondary-button">Back to Story</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Library Page -->
    <div id="libraryPage" class="page">
        <div class="card wide-card">
            <h2>üìö Your Story Library</h2>
            <p class="subtitle">Welcome back, <span id="userNameLibrary">Storyteller</span>! Here are all the stories you've forged.</p>
            
            <div class="button-group">
                <button id="newStoryButton">‚ö° Forge New Story</button>
                <button id="clearLibraryButton" class="secondary-button">Clear Library</button>
            </div>
            
            <div class="story-library">
                <div id="storiesContainer">
                    <div id="loadingStories" class="loading">Loading your stories...</div>
                    <div id="noStories" style="display: none; text-align: center; padding: 40px;">
                        <p>No stories yet! Click "Forge New Story" to begin your first adventure.</p>
                    </div>
                    <div id="storiesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = '';
        let currentStory = '';
        let currentRevision = 0;
        let maxRevisions = 4;
        let currentGuildStory = '';
        let guildRevisionCount = 0;
        let maxGuildRevisions = 3;
        let illustratedPages = [];
        let currentPageIndex = 0;

        // Page management
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Update user names
            if (currentUser) {
                const userElements = document.querySelectorAll('#userName, #userNameLibrary');
                userElements.forEach(el => el.textContent = currentUser);
            }
        }

        // Helper function to format story text with proper paragraphs
        function formatStoryText(text) {
            // Split by newlines and clean up
            const paragraphs = text.split('\n').filter(p => p.trim().length > 0);
            
            // If no natural breaks, try to split by periods followed by capital letters
            if (paragraphs.length === 1) {
                const sentences = text.split(/(?<=\.)\s+(?=[A-Z])/);
                const groupedParagraphs = [];
                for (let i = 0; i < sentences.length; i += 2) {
                    const para = sentences.slice(i, i + 2).join(' ');
                    if (para.trim()) groupedParagraphs.push(para.trim());
                }
                return groupedParagraphs;
            }
            
            return paragraphs.map(p => p.trim());
        }

        // Helper function to display story with proper formatting
        function displayFormattedStory(containerId, storyText) {
            const container = document.getElementById(containerId);
            const paragraphs = formatStoryText(storyText);
            
            container.innerHTML = paragraphs.map(para => `<p>${para}</p>`).join('');
        }
        function saveToStorage(key, data) {
            localStorage.setItem(`storyforge_${key}`, JSON.stringify(data));
        }

        function loadFromStorage(key) {
            const data = localStorage.getItem(`storyforge_${key}`);
            return data ? JSON.parse(data) : null;
        }

        function saveStoryToLibrary(title, originalStory, finalStory) {
            const stories = loadFromStorage('stories') || [];
            const newStory = {
                id: Date.now().toString(),
                title: title || 'Untitled Story',
                originalStory,
                finalStory,
                createdAt: new Date().toISOString()
            };
            stories.unshift(newStory);
            saveToStorage('stories', stories);
            return newStory;
        }

        // AI API calls
        async function callStoryForgeAI(userText, mode, context = '') {
            try {
                let prompt = '';
                
                if (mode === 'editor_feedback') {
                    prompt = `You are the Editor in the StoryForge Guild, mentoring a young Intern (ages 8-16). 

Their story: "${userText}"

Provide encouraging feedback that:
1. Starts with genuine excitement and praise for their creativity
2. Gives 2-3 specific, gentle suggestions for improvement (60% grammar/spelling, 40% story enhancement)
3. Asks 1-2 curious questions to help them add more detail
4. Keeps it warm, supportive, and under 100 words
5. Address them as "Intern" and sign as "Your Editor"

Focus on making them feel proud while gently guiding improvement.`;

                } else if (mode === 'editor_revision') {
                    prompt = `You are the Editor reviewing the Intern's revised story.

Original: "${context}"
Revision: "${userText}"

${currentRevision >= maxRevisions - 1 ? 
                    'This is their final revision - be very encouraging and guide them to finish.' : 
                    'Provide brief, encouraging feedback on their improvements.'}

Respond with:
1. Praise their improvements
2. ${currentRevision >= maxRevisions - 1 ? 
                        'Say their story is excellent and ready for Guild collaboration' : 
                        'One small suggestion OR say it\'s ready for the Guild'}
3. Keep it under 80 words
4. Sign as "Your Editor"`;

                } else if (mode === 'guild_story') {
                    prompt = `You are a Guild writer creating a 12-paragraph children's story based on the Intern's original idea.

Their story: "${userText}"

Write a complete children's story that:
1. Expands their core idea into a full narrative with exactly 12 paragraphs
2. Keeps their main characters and plot elements
3. Adds adventure, dialogue, and descriptive details
4. Has a clear beginning, middle, and satisfying ending
5. Uses simple, engaging language for 10-year-olds
6. Each paragraph should be 2-4 sentences long

Format your response with clear paragraph breaks. Start each paragraph on a new line.

Just write the story - no introduction or explanation needed.`;

                } else if (mode === 'guild_feedback') {
                    prompt = `You are the Guild writer rewriting your story based on the Intern's feedback.

Original story: "${context}"
Their feedback: "${userText}"

Rewrite the complete 12-paragraph children's story incorporating their suggestions:
1. Keep the same basic plot but improve based on their feedback
2. Make the changes they suggested while keeping it a complete story
3. Maintain 12 paragraphs, each 2-4 sentences
4. Use simple, engaging language for 10-year-olds
5. Format with clear paragraph breaks

Write the complete revised story - no explanation, just the new story.`;

                } else if (mode === 'guild_feedback_response') {
                    prompt = `You are the Guild writer responding to the Intern's feedback.

Their feedback: "${userText}"

Respond as the grateful Guild writer:
1. Thank them for their thoughtful feedback
2. Mention one specific thing you improved based on their suggestion
3. ${guildRevisionCount >= maxGuildRevisions - 1 ? 
                        'Say you think the story is now perfect with their help' : 
                        'Ask if they have any other suggestions'}
4. Keep it warm and appreciative, under 60 words
5. Sign as "Your Guild Writer"

This is just your response to their feedback, not the story itself.`;
                }

                const response = await fetch('/api/storyforge-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: mode === 'guild_story' ? 1500 : 500
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;

            } catch (error) {
                console.error('AI call error:', error);
                return "I'm having trouble connecting right now. Please try again in a moment!";
            }
        }

        // Story download function
        function downloadStory() {
            const title = document.getElementById('storyTitle').value || 'My StoryForge Tale';
            const story = document.getElementById('finalStory').textContent;
            const content = `${title}\n\nForged with StoryForge\nWhere Stories Are Forged, Not Just Written\n\n${story}\n\nCreated by: ${currentUser}\nDate: ${new Date().toLocaleDateString()}`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Library management
        function loadLibrary() {
            const stories = loadFromStorage('stories') || [];
            const container = document.getElementById('storiesContainer');
            const loading = document.getElementById('loadingStories');
            const noStories = document.getElementById('noStories');
            const storiesList = document.getElementById('storiesList');

            loading.style.display = 'none';

            if (stories.length === 0) {
                noStories.style.display = 'block';
                storiesList.innerHTML = '';
                return;
            }

            noStories.style.display = 'none';
            storiesList.innerHTML = stories.map(story => `
                <div class="story-item" onclick="viewStory('${story.id}')">
                    <div class="story-title">${story.title}</div>
                    <div class="story-date">Created: ${new Date(story.createdAt).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function viewStory(storyId) {
            const stories = loadFromStorage('stories') || [];
            const story = stories.find(s => s.id === storyId);
            if (story) {
                alert(`${story.title}\n\n${story.finalStory || story.originalStory}`);
            }
        }

        function clearLibrary() {
            if (confirm('Are you sure you want to clear all your stories? This cannot be undone.')) {
                localStorage.removeItem('storyforge_stories');
                loadLibrary();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Check for existing user
            const savedUser = loadFromStorage('user');
            if (savedUser) {
                currentUser = savedUser;
                showPage('libraryPage');
                loadLibrary();
            }

            // Welcome page
            document.getElementById('beginAdventure').addEventListener('click', () => {
                const name = document.getElementById('nameInput').value.trim();
                if (!name) {
                    alert('Please enter your name to begin your adventure!');
                    return;
                }
                currentUser = name;
                saveToStorage('user', name);
                showPage('workshopPage');
            });

            // Workshop page
            document.getElementById('getEditorFeedback').addEventListener('click', async () => {
                const story = document.getElementById('storyInput').value.trim();
                if (!story) {
                    alert('Please write your story first!');
                    return;
                }
                
                currentStory = story;
                currentRevision = 0;
                document.getElementById('editableStory').value = story;
                
                const responseDiv = document.getElementById('editorResponse');
                responseDiv.innerHTML = '<div class="loading">Your Editor is reviewing your story...</div>';
                
                showPage('editorPage');
                
                const feedback = await callStoryForgeAI(story, 'editor_feedback');
                responseDiv.innerHTML = `
                    <div class="character-badge">Your Editor</div>
                    <p>${feedback}</p>
                `;
            });

            document.getElementById('backToDashboard').addEventListener('click', () => {
                showPage('libraryPage');
                loadLibrary();
            });

            // Editor page
            document.getElementById('submitRevision').addEventListener('click', async () => {
                const revisedStory = document.getElementById('editableStory').value.trim();
                if (!revisedStory) {
                    alert('Please revise your story!');
                    return;
                }

                currentRevision++;
                const responseDiv = document.getElementById('editorResponse');
                responseDiv.innerHTML = '<div class="loading">Your Editor is reviewing your revision...</div>';

                const feedback = await callStoryForgeAI(revisedStory, 'editor_revision', currentStory);
                responseDiv.innerHTML = `
                    <div class="character-badge">Your Editor</div>
                    <p>${feedback}</p>
                `;

                currentStory = revisedStory;

                if (currentRevision >= maxRevisions || feedback.toLowerCase().includes('ready') || feedback.toLowerCase().includes('excellent')) {
                    document.getElementById('acceptStory').textContent = 'Move to Guild!';
                }
            });

            document.getElementById('acceptStory').addEventListener('click', () => {
                currentStory = document.getElementById('editableStory').value.trim();
                showPage('guildPage');
            });

            // Guild page
            document.getElementById('allowCollaboration').addEventListener('click', async () => {
                document.getElementById('guildChoice').style.display = 'none';
                document.getElementById('guildStorySection').style.display = 'block';
                
                guildRevisionCount = 0;
                const guildStoryDiv = document.getElementById('guildStory');
                guildStoryDiv.innerHTML = '<div class="loading">The Guild writer is crafting their version...</div>';

                const guildStory = await callStoryForgeAI(currentStory, 'guild_story');
                currentGuildStory = guildStory;
                displayFormattedStory('guildStory', guildStory);
            });

            document.getElementById('declineCollaboration').addEventListener('click', () => {
                displayFormattedStory('finalStory', currentStory);
                showPage('successPage');
            });

            document.getElementById('submitFeedback').addEventListener('click', async () => {
                const feedback = document.getElementById('feedbackInput').value.trim();
                if (!feedback) {
                    alert('Please provide feedback for the Guild writer!');
                    return;
                }

                guildRevisionCount++;
                
                // Show loading for both response and new story
                const guildStoryDiv = document.getElementById('guildStory');
                guildStoryDiv.innerHTML = '<div class="loading">The Guild writer is revising the story based on your feedback...</div>';

                // Get both the response AND the revised story
                const revisedStory = await callStoryForgeAI(feedback, 'guild_feedback', currentGuildStory);
                const writerResponse = await callStoryForgeAI(feedback, 'guild_feedback_response');
                
                // Update the current story
                currentGuildStory = revisedStory;
                displayFormattedStory('guildStory', revisedStory);
                
                // Show the writer's response
                const responseDiv = document.createElement('div');
                responseDiv.className = 'ai-response';
                responseDiv.innerHTML = `
                    <div class="character-badge">Guild Writer Response</div>
                    <p>${writerResponse}</p>
                `;
                document.getElementById('guildStorySection').appendChild(responseDiv);

                document.getElementById('feedbackInput').value = '';

                if (guildRevisionCount >= maxGuildRevisions) {
                    document.getElementById('approveFinalStory').textContent = 'Finish Story!';
                }
            });

            document.getElementById('approveFinalStory').addEventListener('click', () => {
                displayFormattedStory('finalStory', currentGuildStory);
                showPage('successPage');
            });

            // Success page
            document.getElementById('saveStory').addEventListener('click', () => {
                const title = document.getElementById('storyTitle').value.trim();
                const finalStoryDiv = document.getElementById('finalStory');
                const finalStory = finalStoryDiv.innerHTML; // Get formatted HTML
                
                saveStoryToLibrary(title, currentStory, finalStory);
                alert('Story saved to your library!');
                
                // Reset for next story
                currentStory = '';
                currentGuildStory = '';
                currentRevision = 0;
                guildRevisionCount = 0;
                
                showPage('libraryPage');
                loadLibrary();
            });

            document.getElementById('downloadStory').addEventListener('click', downloadStory);

            document.getElementById('createAnother').addEventListener('click', () => {
                // Reset story state
                currentStory = '';
                currentGuildStory = '';
                currentRevision = 0;
                guildRevisionCount = 0;
                document.getElementById('storyInput').value = '';
                showPage('workshopPage');
            });

            document.getElementById('viewLibrary').addEventListener('click', () => {
                showPage('libraryPage');
                loadLibrary();
            });

            // Illustrated book functionality
            document.getElementById('createIllustratedBook').addEventListener('click', createIllustratedBook);
            
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPageIndex > 0) {
                    currentPageIndex--;
                    showPage(currentPageIndex);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPageIndex < illustratedPages.length - 1) {
                    currentPageIndex++;
                    showPage(currentPageIndex);
                }
            });
            
            document.getElementById('backToStory').addEventListener('click', () => {
                showPage('successPage');
            });
            
            document.getElementById('downloadIllustratedBook').addEventListener('click', () => {
                // For now, just alert - could implement PDF generation later
                alert('Illustrated book download feature coming soon! For now, you can screenshot each page.');
            });

            // Library page
            document.getElementById('newStoryButton').addEventListener('click', () => {
                document.getElementById('storyInput').value = '';
                showPage('workshopPage');
            });

            document.getElementById('clearLibraryButton').addEventListener('click', clearLibrary);
        });
    </script>
</body>
</html>
