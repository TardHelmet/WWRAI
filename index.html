<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch.Right.Android - Story Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .page {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .page.active {
            display: block;
        }
        
        h1, h2 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            background: #ffd700;
            color: #333;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin: 10px;
        }
        
        button:hover {
            background: #ffed4e;
        }
        
        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        .video-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            resize: none;
            margin: 20px 0;
            box-sizing: border-box;
        }
        
        .pause-prompt {
            background: rgba(255, 215, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            margin: 20px 0;
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
        }
        
        .editor-response {
            background: rgba(147, 51, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #ffd700;
        }
        
        .character-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 18px;
        }
        
        .story-display {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 25px;
            font-family: monospace;
            font-size: 18px;
            display: none;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .center {
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Welcome Page -->
    <div class="page active" id="welcomePage">
        <h1>‚ú® Story Creator ‚ú®</h1>
        <div class="center">
            <p>Watch a magical video and help create an amazing story!</p>
            <button id="startButton">Start Your Story Adventure! üöÄ</button>
            <div id="connectionStatus" class="status"></div>
        </div>
    </div>

    <!-- Video Page -->
    <div class="page" id="videoPage">
        <div class="timer" id="timer">00:00</div>
        <h2>üì∫ Let's Watch Together!</h2>
        <div class="video-container">
            <iframe id="videoPlayer" width="100%" height="315" 
                    src="https://www.youtube.com/embed/ScMzIvxBSi4" 
                    frameborder="0" allowfullscreen></iframe>
        </div>
        
        <div id="pausePrompt" class="pause-prompt">
            <h3>‚úã Pause Time!</h3>
            <p id="pauseQuestion">What just happened in the story?</p>
            <textarea id="storyInput" placeholder="Tell me what you saw..."></textarea>
            <div class="center">
                <button id="continueButton">Continue Watching ‚ñ∂Ô∏è</button>
                <button id="finishButton">I'm Done Writing! ‚úÖ</button>
            </div>
        </div>
    </div>

    <!-- Story Review Page -->
    <div class="page" id="reviewPage">
        <h2>üìñ Your Amazing Story!</h2>
        <div id="fullStory" class="story-display"></div>
        <div class="center">
            <p>Ready to send your story to our magical editor?</p>
            <button id="sendEditorButton">Send to Editor üìÆ</button>
        </div>
    </div>

    <!-- Waiting Page -->
    <div class="page" id="waitingPage">
        <h2>üßô‚Äç‚ôÇÔ∏è Editor is Working Magic...</h2>
        <div class="center">
            <p>Grammaticus is reading your story and preparing helpful suggestions!</p>
            <div style="font-size: 3em; animation: spin 2s linear infinite;">‚è≥</div>
            <p><small>This usually takes a few moments...</small></p>
        </div>
    </div>

    <!-- Editor Response Page -->
    <div class="page" id="editorPage">
        <h2>üì¨ Message from Your Editor!</h2>
        <div id="editorResponse" class="editor-response"></div>
        <h3>Your Story (you can edit it):</h3>
        <textarea id="editStory" placeholder="Edit your story here..."></textarea>
        <div class="center">
            <button id="submitRevisionButton">Send Back to Editor üìù</button>
            <button id="finalizeButton">My Story is Perfect! ‚≠ê</button>
        </div>
    </div>

    <!-- Success Page -->
    <div class="page" id="successPage">
        <h1>üéâ Congratulations!</h1>
        <div class="center">
            <p>You've created an amazing story! Your writing skills are getting stronger every day.</p>
            <div id="finalStory" class="story-display"></div>
            <button id="newStoryButton">Create Another Story! üîÑ</button>
        </div>
    </div>

    <script>
        // Story session data
        let storyParts = [];
        let pauseTimes = [15, 45, 75, 105]; // Change these pause times as needed
        let currentPauseIndex = 0;
        let sessionStartTime = Date.now();
        let timerInterval;
        
        // Simple page management - no fading, just show/hide
        function showPage(pageId) {
            console.log("Switching to page:", pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show the requested page
            document.getElementById(pageId).classList.add('active');
        }
        
        // Timer functions
        function startTimer() {
            document.getElementById('timer').style.display = 'block';
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
        }
        
        // Story flow functions
        function startStorySession() {
            console.log("Starting story session...");
            showPage('videoPage');
            startTimer();
            // Auto-pause after first interval
            setTimeout(() => pauseVideo(), pauseTimes[0] * 1000);
        }
        
        function pauseVideo() {
            console.log("Pausing video for input...");
            const questions = [
                "What happened in the beginning of the story?",
                "Who are the main characters and what are they doing?",
                "What problem or challenge appeared?",
                "How do you think the story will end?"
            ];
            
            document.getElementById('pauseQuestion').textContent = 
                questions[currentPauseIndex] || "What just happened?";
            document.getElementById('pausePrompt').style.display = 'block';
            
            // Focus on textarea
            setTimeout(() => {
                document.getElementById('storyInput').focus();
            }, 100);
        }
        
        function continueVideo() {
            const storyPart = document.getElementById('storyInput').value.trim();
            if (!storyPart) {
                alert('Please write something about what happened!');
                return;
            }
            
            storyParts.push(storyPart);
            document.getElementById('storyInput').value = '';
            document.getElementById('pausePrompt').style.display = 'none';
            
            currentPauseIndex++;
            if (currentPauseIndex < pauseTimes.length) {
                const nextPause = pauseTimes[currentPauseIndex] - pauseTimes[currentPauseIndex - 1];
                setTimeout(() => pauseVideo(), nextPause * 1000);
            } else {
                // Video finished, final pause
                setTimeout(() => {
                    document.getElementById('pauseQuestion').textContent = "How did the story end?";
                    document.getElementById('pausePrompt').style.display = 'block';
                }, 30000);
            }
        }
        
        function finishStory() {
            const finalPart = document.getElementById('storyInput').value.trim();
            if (finalPart) {
                storyParts.push(finalPart);
            }
            
            if (storyParts.length === 0) {
                alert('Please write at least one part of the story!');
                return;
            }
            
            stopTimer();
            displayFullStory();
            showPage('reviewPage');
        }
        
        function displayFullStory() {
            const fullStory = storyParts.join(' ');
            document.getElementById('fullStory').textContent = fullStory;
            document.getElementById('editStory').value = fullStory;
            document.getElementById('finalStory').textContent = fullStory;
        }
        
        async function sendToEditor() {
            const sendButton = document.getElementById('sendEditorButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            showPage('waitingPage');
            
            try {
                const fullStory = storyParts.join(' ');
                const editorResponse = await callGeminiAPI(fullStory, 'editor');
                
                document.getElementById('editorResponse').innerHTML = `
                    <div class="character-name">üßô‚Äç‚ôÇÔ∏è Grammaticus says:</div>
                    <p>${editorResponse}</p>
                `;
                
                showNotification('üì¨ You have a message from your editor!');
                setTimeout(() => showPage('editorPage'), 2000);
                
            } catch (error) {
                console.error('Editor API Error:', error);
                alert(`Editor is busy right now: ${error.message}`);
                showPage('reviewPage');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send to Editor üìÆ';
            }
        }
        
        async function submitRevision() {
            const revisedStory = document.getElementById('editStory').value;
            
            if (!revisedStory.trim()) {
                alert('Please write your story before sending it back!');
                return;
            }
            
            showPage('waitingPage');
            
            try {
                const feedback = await callGeminiAPI(revisedStory, 'revision');
                
                document.getElementById('editorResponse').innerHTML = `
                    <div class="character-name">üßô‚Äç‚ôÇÔ∏è Grammaticus says:</div>
                    <p>${feedback}</p>
                `;
                
                showNotification('üì¨ Your editor responded!');
                setTimeout(() => showPage('editorPage'), 2000);
                
            } catch (error) {
                console.error('Revision API Error:', error);
                alert(`Editor is busy: ${error.message}`);
                showPage('editorPage');
            }
        }
        
        function finalizeStory() {
            const finalStory = document.getElementById('editStory').value;
            document.getElementById('finalStory').textContent = finalStory;
            showPage('successPage');
        }
        
        function startNewStory() {
            // Reset everything
            storyParts = [];
            currentPauseIndex = 0;
            sessionStartTime = Date.now();
            document.getElementById('storyInput').value = '';
            document.getElementById('editStory').value = '';
            document.getElementById('pausePrompt').style.display = 'none';
            showPage('welcomePage');
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.onclick = () => notification.remove();
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
        
        // API call function
        async function callGeminiAPI(storyText, mode) {
            let prompt;
            if (mode === 'editor') {
                prompt = `You are Grammaticus, a magical writing editor who helps children improve their stories. A child just wrote this story after watching a video: "${storyText}"

Respond as a friendly editor with:
1. Specific praise for what they did well
2. 2-3 gentle suggestions to make it even better
3. Ask one question to help them think deeper
4. Keep it encouraging and under 80 words
5. Use magical, playful language

Be like a wise, kind teacher who makes writing fun!`;
            } else {
                prompt = `You are Grammaticus responding to a child's revised story. Original story: "${storyParts.join(' ')}" 
Revised version: "${storyText}"

Give encouraging feedback on their improvements and either:
- Suggest one final small enhancement, OR
- Congratulate them on their excellent work if it's ready

Keep it brief, magical, and supportive (under 60 words).`;
            }
            
            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 150
                }
            };
            
            const response = await fetch('/api/editor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Invalid response from AI service');
            }
            
            return data.candidates[0].content.parts[0].text;
        }
        
        // Setup event listeners when page loads
        window.addEventListener('load', async () => {
            console.log("Setting up event listeners...");
            
            // Test server connection
            const statusElement = document.getElementById('connectionStatus');
            try {
                const response = await fetch('/health');
                const data = await response.json();
                console.log('‚úÖ Server connection OK:', data);
                statusElement.innerHTML = `<span style="color: #28a745;">‚úÖ Server Ready</span>`;
            } catch (error) {
                console.error('‚ùå Server connection failed:', error);
                statusElement.innerHTML = `<span style="color: #dc3545;">‚ùå Server Issue</span>`;
            }
            
            // Add all button event listeners
            document.getElementById('startButton').addEventListener('click', startStorySession);
            document.getElementById('continueButton').addEventListener('click', continueVideo);
            document.getElementById('finishButton').addEventListener('click', finishStory);
            document.getElementById('sendEditorButton').addEventListener('click', sendToEditor);
            document.getElementById('submitRevisionButton').addEventListener('click', submitRevision);
            document.getElementById('finalizeButton').addEventListener('click', finalizeStory);
            document.getElementById('newStoryButton').addEventListener('click', startNewStory);
            
            console.log("‚úÖ All event listeners ready!");
        });
        
        console.log("üé¨ Story Creator loaded!");
    </script>
</body>
</html>