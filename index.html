<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryForge - Forge Your Own Epic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 50%, #1e3a8a 100%);
            color: #1f2937;
            min-height: 100vh;
        }
        
        .page {
            display: none;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        .page.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #1e40af;
            text-align: center;
            margin-bottom: 24px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        h2 {
            color: #1e40af;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        h3 {
            color: #374151;
            margin-bottom: 16px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .tagline {
            text-align: center;
            color: #6b7280;
            font-size: 1.1rem;
            margin-bottom: 32px;
            font-style: italic;
        }

        button {
            background: #10b981;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            margin: 8px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #6b7280;
        }

        .button-secondary:hover {
            background: #4b5563;
        }

        .button-warning {
            background: #f59e0b;
        }

        .button-warning:hover {
            background: #d97706;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin: 12px 0;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #10b981;
        }
        
        .video-container {
            width: 100%;
            max-width: 640px;
            margin: 24px auto;
            text-align: center;
        }

        .video-container iframe {
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            margin: 16px 0;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #10b981;
        }
        
        .writing-prompt {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            padding: 24px;
            border-radius: 12px;
            margin: 24px 0;
            display: none;
        }

        .writing-prompt.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .editor-response {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 24px;
            border-radius: 12px;
            margin: 24px 0;
        }
        
        .character-name {
            font-weight: 700;
            color: #1e40af;
            font-size: 1.1rem;
            margin-bottom: 12px;
        }
        
        .story-display {
            background: #f9fafb;
            padding: 24px;
            border-radius: 12px;
            margin: 20px 0;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }
        
        .story-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 16px 0;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }
        
        .story-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .story-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .story-preview {
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .story-date {
            font-size: 0.9rem;
            color: #9ca3af;
        }
        
        .timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            font-family: monospace;
            font-size: 18px;
            display: none;
        }

        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            font-size: 14px;
            display: none;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            color: #6b7280;
        }

        .center {
            text-align: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 8px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .step.active {
            color: #10b981;
            font-weight: 600;
        }

        .step.completed {
            color: #6b7280;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            animation: spin 2s linear infinite;
            font-size: 2rem;
            margin: 20px 0;
        }

        .guild-badge {
            background: #7c3aed;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 8px;
        }

        .privacy-note {
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
            margin-top: 24px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="page active" id="loginPage">
        <div class="card">
            <h1>‚öíÔ∏è StoryForge</h1>
            <div class="tagline">Forge Your Own Epic. Learn to Write, One Story at a Time.</div>
            
            <div class="login-form">
                <p style="text-align: center; margin-bottom: 32px; color: #6b7280;">Welcome to the Storymakers Guild! Create amazing stories with help from our AI writing mentors.</p>
                
                <div id="loginSection">
                    <h3>Already a Storymaker?</h3>
                    <div class="center">
                        <button id="loginButton">üîê Continue Your Journey</button>
                    </div>
                </div>
                
                <div id="registerSection">
                    <h3>Join the Guild</h3>
                    <input type="text" id="firstNameInput" placeholder="What should we call you?" maxlength="50">
                    <div class="center">
                        <button id="registerButton">‚öíÔ∏è Become a Storymaker</button>
                    </div>
                </div>
                
                <div id="connectionStatus" class="status"></div>
                
                <div class="privacy-note">
                    üîí Your stories and data stay private and secure on your device
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div class="page" id="dashboardPage">
        <div class="user-info" id="userInfo"></div>
        
        <div class="card">
            <h1>üìö Your Story Library</h1>
            <div class="guild-badge">Storymaker Intern</div>
            
            <div class="center">
                <button id="newStoryButton">‚ú® Forge a New Story</button>
                <button id="logoutButton" class="button-secondary">üö™ Leave Guild</button>
            </div>
            
            <div id="storiesContainer" style="margin-top: 32px;">
                <div id="loadingStories" class="center">Loading your stories...</div>
                <div id="noStories" class="center" style="display: none;">
                    <p>No stories forged yet! Create your first masterpiece.</p>
                </div>
                <div id="storiesList"></div>
            </div>
        </div>
    </div>

    <!-- Welcome Page -->
    <div class="page" id="welcomePage">
        <div class="user-info" id="userInfoWelcome"></div>
        
        <div class="card">
            <h1>‚öíÔ∏è Welcome to the Storymakers Guild</h1>
            <div class="guild-badge">Writing Assignment Available</div>
            
            <div class="center">
                <p style="margin-bottom: 24px; font-size: 1.1rem;">As a new Intern, you'll learn to craft stories by watching inspiring videos and letting your imagination run wild. Your writing mentor will guide you through each step.</p>
                
                <div style="background: #f0f9ff; padding: 24px; border-radius: 12px; margin: 24px 0;">
                    <h3>üé¨ Your First Assignment</h3>
                    <p>Watch a short video and create an original story inspired by what you see. Don't worry about being perfect - we're here to help you improve!</p>
                </div>
                
                <button id="startButton">Begin Your Story Journey ‚öíÔ∏è</button>
                <button id="backToDashboardButton" class="button-secondary">üìö Back to Library</button>
            </div>
        </div>
    </div>

    <!-- Video Page with Integrated Writing -->
    <div class="page" id="videoPage">
        <div class="timer" id="timer">00:00</div>
        <div class="user-info" id="userInfoVideo"></div>
        
        <div class="card">
            <h2>üé¨ Story Forge Workshop</h2>
            
            <div class="step-indicator">
                <div class="step active">Watch & Write</div>
                <div class="step">Review</div>
                <div class="step">Refine</div>
                <div class="step">Complete</div>
            </div>
            
            <p style="text-align: center; margin-bottom: 24px; color: #6b7280;">
                Watch this video and build your story piece by piece. We'll pause every 30 seconds for you to write!
            </p>
            
            <!-- Video and Writing Combined Interface -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;" id="videoWritingContainer">
                <!-- Video Side -->
                <div>
                    <div class="video-container">
                        <iframe id="videoPlayer" width="100%" height="300" 
                                src="https://www.youtube.com/embed/OvOrbWggMTs?autoplay=1&mute=1" 
                                frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        <div style="color: #10b981; font-weight: 600;">üé¨ Watch and Write</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Write your story as you watch the video</div>
                    </div>
                </div>
                
                <!-- Writing Side -->
                <div>
                    <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; border: 2px solid #0ea5e9; margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #0ea5e9;">‚úçÔ∏è Write Your Story</h3>
                        <p style="margin: 0 0 12px 0; font-size: 0.9rem; color: #6b7280;">Let the video inspire you! Write your story as you watch.</p>
                        <textarea id="storyInput" placeholder="Start writing your story here..." style="min-height: 200px; margin-bottom: 12px;"></textarea>
                    </div>
                    
                    <!-- Story Preview -->
                    <div id="storyPreview" style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">üìñ Your Story Preview:</div>
                        <div id="storyContent" style="font-size: 0.9rem; line-height: 1.5; color: #6b7280; font-style: italic;">Start writing to see your story appear here...</div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Layout (Stack Vertically) -->
            <div style="display: none;" id="mobileVideoWriting">
                <div class="video-container" style="margin-bottom: 16px;">
                    <iframe id="videoPlayerMobile" width="100%" height="250" 
                            src="https://www.youtube.com/embed/OvOrbWggMTs?autoplay=1&mute=1" 
                            frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>
                </div>
                
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="color: #10b981; font-weight: 600;">üé¨ Watch and Write</div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Write your story as you watch the video</div>
                </div>
                
                <div style="background: #f0f9ff; padding: 16px; border-radius: 12px; border: 2px solid #0ea5e9; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; color: #0ea5e9;">‚úçÔ∏è Write Your Story</h3>
                    <p style="margin: 0 0 12px 0; font-size: 0.9rem; color: #6b7280;">Let the video inspire you! Write your story as you watch.</p>
                    <textarea id="storyInputMobile" placeholder="Start writing your story here..." style="min-height: 120px; margin-bottom: 12px;"></textarea>
                </div>
                
                <div id="storyPreviewMobile" style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">üìñ Your Story Preview:</div>
                    <div id="storyContentMobile" style="font-size: 0.9rem; line-height: 1.5; color: #6b7280; font-style: italic;">Start writing to see your story appear here...</div>
                </div>
            </div>
            
            <!-- Control Buttons -->
            <div class="center" style="margin-top: 24px;">
                <button id="finishStoryButton" style="background: #7c3aed;">‚ú® Finish My Story</button>
                <button id="backToDashboardFromVideo" style="background: #6b7280;">üìö Back to Library</button>
            </div>
        </div>
    </div>

    <!-- Story Review Page -->
    <div class="page" id="reviewPage">
        <div class="card">
            <h2>üìñ Your Story Draft</h2>
            
            <div class="step-indicator">
                <div class="step completed">Watch</div>
                <div class="step active">Create</div>
                <div class="step">Refine</div>
                <div class="step">Complete</div>
            </div>
            
            <div id="fullStory" class="story-display"></div>
            
            <div class="center">
                <p style="margin-bottom: 20px;">Ready to get feedback from your Writing Mentor?</p>
                <button id="sendEditorButton">üìù Send to Writing Mentor</button>
                <button id="saveStoryButton" class="button-secondary">üíæ Save As-Is</button>
            </div>
        </div>
    </div>

    <!-- Waiting Page -->
    <div class="page" id="waitingPage">
        <div class="card">
            <h2>‚öíÔ∏è Your Mentor is Reading...</h2>
            <div class="center">
                <p>The Writing Mentor is carefully reading your story and preparing helpful suggestions!</p>
                <div class="loading-spinner">‚è≥</div>
                <p><small>This usually takes just a moment...</small></p>
            </div>
        </div>
    </div>

    <!-- Editor Response Page -->
    <div class="page" id="editorPage">
        <div class="card">
            <h2>üìù Mentor Feedback</h2>
            
            <div class="step-indicator">
                <div class="step completed">Watch</div>
                <div class="step completed">Create</div>
                <div class="step active">Refine</div>
                <div class="step">Complete</div>
            </div>
            
            <div id="editorResponse" class="editor-response"></div>
            
            <h3>Improve Your Story:</h3>
            <textarea id="editStory" placeholder="Revise your story based on the feedback..."></textarea>
            
            <!-- Revision buttons -->
            <div id="revisionButtons" class="center" style="display: none;">
                <button id="submitRevisionButton">üìù Send Updated Story</button>
                <button id="finalizeButton">‚ú® My Story is Ready!</button>
            </div>
            
            <!-- Guild collaboration buttons -->
            <div id="guildButtons" class="center" style="display: none;">
                <button id="sendToGuildButton" style="background: #7c3aed;">
                    ‚öíÔ∏è Send to Storymakers Guild
                </button>
                <button id="keepStoryButton" class="button-secondary">
                    üìö Keep My Version
                </button>
            </div>
            
            <!-- Guild feedback section -->
            <div id="guildSection" style="display: none;">
                <div class="center">
                    <button id="submitGuildFeedbackButton">üìù Send Feedback to Guild</button>
                    <button id="approveGuildButton">üåü Guild Story is Perfect!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Page -->
    <div class="page" id="successPage">
        <div class="card">
            <h1>üéâ Story Complete!</h1>
            
            <div class="step-indicator">
                <div class="step completed">Watch</div>
                <div class="step completed">Create</div>
                <div class="step completed">Refine</div>
                <div class="step completed">Complete</div>
            </div>
            
            <div class="center">
                <div class="guild-badge">Story Forged Successfully!</div>
                <p style="margin: 20px 0;">Congratulations! You've created an amazing story. Your writing skills are getting stronger with every tale you forge.</p>
                
                <div id="finalStory" class="story-display"></div>
                
                <input type="text" id="storyTitle" placeholder="Give your story a title..." style="margin: 20px 0;">
                
                <div>
                    <button id="saveFinishedStoryButton">üíæ Save to Library</button>
                    <button id="createAnotherButton">üîÑ Forge Another Story</button>
                    <button id="viewLibraryButton" class="button-secondary">üìö View Library</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <script>
        console.log('üé¨ StoryForge loading...');
        
        // Global variables
        let currentUser = null;
        let sessionStartTime = Date.now();
        let timerInterval;
        let currentOriginalStory = '';
        let currentAIStory = '';
        
        // Page management
        function showPage(pageId) {
            console.log("Switching to page:", pageId);
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            updateUserInfo();
        }
        
        function updateUserInfo() {
            if (currentUser) {
                const userDisplay = `üëã ${currentUser.firstName}`;
                document.getElementById('userInfo').textContent = userDisplay;
                document.getElementById('userInfoWelcome').textContent = userDisplay;
                document.getElementById('userInfoVideo').textContent = userDisplay;
                
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfoWelcome').style.display = 'block';
                document.getElementById('userInfoVideo').style.display = 'block';
            }
        }
        
        // Authentication functions
        async function registerUser() {
            console.log('üöÄ Register button clicked!');
            
            const firstName = document.getElementById('firstNameInput').value.trim();
            
            if (!firstName) {
                alert('Please enter your name');
                return;
            }
            
            if (firstName.length > 50) {
                alert('Name is too long');
                return;
            }
            
            try {
                if (!window.PublicKeyCredential) {
                    alert('Secure login is not supported on this device');
                    return;
                }
                
                document.getElementById('registerButton').disabled = true;
                document.getElementById('registerButton').textContent = 'Joining Guild...';
                
                // Start registration
                const beginResponse = await fetch('/api/auth/register/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName })
                });
                
                if (!beginResponse.ok) {
                    throw new Error(`Server error: ${beginResponse.status}`);
                }
                
                const { options, userId } = await beginResponse.json();
                
                // Create credential
                const credential = await SimpleWebAuthnBrowser.startRegistration(options);
                
                // Complete registration
                const completeResponse = await fetch('/api/auth/register/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, firstName, credential })
                });
                
                const result = await completeResponse.json();
                
                if (result.verified) {
                    currentUser = result.user;
                    showNotification('Welcome to the Storymakers Guild! üéâ');
                    await loadDashboard();
                } else {
                    alert('Account creation failed. Please try again.');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                alert(`Account creation failed: ${error.message}`);
            } finally {
                document.getElementById('registerButton').disabled = false;
                document.getElementById('registerButton').textContent = '‚öíÔ∏è Become a Storymaker';
            }
        }
        
        async function loginUser() {
            try {
                if (!window.PublicKeyCredential) {
                    alert('Secure login is not supported on this device');
                    return;
                }
                
                document.getElementById('loginButton').disabled = true;
                document.getElementById('loginButton').textContent = 'Entering Guild...';
                
                const beginResponse = await fetch('/api/auth/login/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const options = await beginResponse.json();
                const credential = await SimpleWebAuthnBrowser.startAuthentication(options);
                
                const completeResponse = await fetch('/api/auth/login/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential })
                });
                
                const result = await completeResponse.json();
                
                if (result.verified) {
                    currentUser = result.user;
                    showNotification(`Welcome back, ${currentUser.firstName}! üëã`);
                    await loadDashboard();
                } else {
                    alert('Login failed. Please try again.');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                if (error.name === 'NotAllowedError') {
                    alert('Login was cancelled. Please try again.');
                } else {
                    alert('Login failed. Please try again.');
                }
            } finally {
                document.getElementById('loginButton').disabled = false;
                document.getElementById('loginButton').textContent = 'üîê Continue Your Journey';
            }
        }
        
        function logout() {
            currentUser = null;
            showPage('loginPage');
            showNotification('Until next time, Storymaker! üëã');
        }
        
        // Dashboard functions
        async function loadDashboard() {
            showPage('dashboardPage');
            
            try {
                const response = await fetch(`/api/stories/${currentUser.id}`);
                const data = await response.json();
                displayStories(data.stories);
            } catch (error) {
                console.error('Error loading stories:', error);
                document.getElementById('loadingStories').textContent = 'Error loading stories';
            }
        }
        
        function displayStories(stories) {
            const container = document.getElementById('storiesList');
            const loading = document.getElementById('loadingStories');
            const noStories = document.getElementById('noStories');
            
            loading.style.display = 'none';
            
            if (!stories || stories.length === 0) {
                noStories.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            noStories.style.display = 'none';
            
            container.innerHTML = stories.map(story => {
                const preview = (story.ai_edited_story || story.original_story).substring(0, 120) + '...';
                const date = new Date(story.created_at).toLocaleDateString();
                
                return `
                    <div class="story-item" onclick="viewStory('${story.id}', '${story.title}', '${story.original_story}', '${story.ai_edited_story || ''}')">
                        <div class="story-title">${story.title}</div>
                        <div class="story-preview">${preview}</div>
                        <div class="story-date">Forged: ${date}</div>
                    </div>
                `;
            }).join('');
        }
        
        function viewStory(id, title, originalStory, aiStory) {
            const storyContent = aiStory || originalStory;
            alert(`${title}\n\n${storyContent}`);
        }
        
        // Story creation flow
        function startStorySession() {
            console.log("Starting story session...");
            storyParts = [];
            currentPauseIndex = 0;
            sessionStartTime = Date.now();
            videoFinished = false;
            videoPaused = false;
            currentVideoTime = 0;
            
            showPage('videoPage');
            startTimer();
            updateStoryDisplay();
            setupVideoInterface();
            
            // Start the first countdown
            startCountdown();
        }
        
        function setupVideoInterface() {
            // Set up responsive layout
            checkMobileLayout();
            window.addEventListener('resize', checkMobileLayout);
            
            // Get video element
            videoElement = document.getElementById('videoPlayer') || document.getElementById('videoPlayerMobile');
            
            if (videoElement && videoElement.tagName === 'VIDEO') {
                // HTML5 video - we can control it
                videoElement.addEventListener('loadeddata', () => {
                    console.log('Video loaded, starting autoplay...');
                    videoDuration = Math.floor(videoElement.duration) || 180;
                    
                    // Ensure video starts playing
                    videoElement.play().then(() => {
                        console.log('Video playing successfully');
                        startCountdown();
                    }).catch(err => {
                        console.log('Autoplay failed, user interaction required:', err);
                        // Show play button if autoplay fails
                        showManualPlayButton();
                    });
                });
                
                videoElement.addEventListener('timeupdate', () => {
                    currentVideoTime = Math.floor(videoElement.currentTime);
                });
                
                videoElement.addEventListener('ended', () => {
                    finishVideo();
                });
                
                // Try to start playing immediately
                if (videoElement.readyState >= 2) {
                    videoDuration = Math.floor(videoElement.duration) || 180;
                    videoElement.play().then(() => {
                        startCountdown();
                    }).catch(() => {
                        showManualPlayButton();
                    });
                }
            } else {
                // YouTube iframe fallback - use manual timing
                console.log('Using YouTube iframe, starting manual countdown...');
                videoDuration = 180; // Default duration
                startCountdown();
            }
            
            // Update initial prompt
            updateCurrentPrompt();
            
            // Set up video controls
            document.getElementById('videoStatus').textContent = '‚ñ∂Ô∏è Video Starting...';
            document.getElementById('finishVideoButton').style.display = 'none';
        }
        
        function showManualPlayButton() {
            const playButton = document.createElement('button');
            playButton.textContent = '‚ñ∂Ô∏è Start Video & Story';
            playButton.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
                background: #10b981;
                color: white;
                padding: 16px 32px;
                border: none;
                border-radius: 8px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
            `;
            
            playButton.onclick = () => {
                if (videoElement && videoElement.tagName === 'VIDEO') {
                    videoElement.play();
                }
                startCountdown();
                playButton.remove();
                document.getElementById('videoStatus').textContent = '‚ñ∂Ô∏è Video Playing';
            };
            
            document.querySelector('.video-container').style.position = 'relative';
            document.querySelector('.video-container').appendChild(playButton);
        }
        
        function checkMobileLayout() {
            const isMobile = window.innerWidth < 768;
            document.getElementById('videoWritingContainer').style.display = isMobile ? 'none' : 'grid';
            document.getElementById('mobileVideoWriting').style.display = isMobile ? 'block' : 'none';
        }
        
        function updateCurrentPrompt() {
            const prompts = [
                "Start your story with what you see...",
                "Continue your story! What happens next?",
                "Keep building! Add more details...",
                "Your story is growing! What develops?",
                "Add more! How is it coming together?",
                "Finish strong! How does it end?"
            ];
            
            const prompt = prompts[currentPauseIndex] || "Continue building your story...";
            document.getElementById('currentPrompt').textContent = prompt;
            
            // Update mobile version too
            const mobilePrompt = document.getElementById('currentPromptMobile');
            if (mobilePrompt) {
                mobilePrompt.textContent = prompt;
            }
        }
        
        function startCountdown() {
            if (videoFinished) return;
            
            const nextPauseTime = pauseTimes[currentPauseIndex] || videoDuration;
            let timeRemaining = nextPauseTime - currentVideoTime;
            
            // Clear any existing countdown
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            countdownTimer = setInterval(() => {
                timeRemaining--;
                currentVideoTime++;
                
                // Update countdown displays
                document.getElementById('countdown').textContent = Math.max(0, timeRemaining);
                const mobileCountdown = document.getElementById('countdownMobile');
                if (mobileCountdown) {
                    mobileCountdown.textContent = Math.max(0, timeRemaining);
                }
                
                // Check if it's time to pause or if video is finished
                if (timeRemaining <= 0) {
                    if (currentVideoTime >= videoDuration) {
                        finishVideo();
                    } else {
                        pauseForWriting();
                    }
                    clearInterval(countdownTimer);
                }
            }, 1000);
        }
        
        function pauseForWriting() {
            videoPaused = true;
            
            // Pause the actual video if it's HTML5
            if (videoElement && videoElement.tagName === 'VIDEO') {
                videoElement.pause();
            }
            
            document.getElementById('videoStatus').textContent = '‚è∏Ô∏è Paused for Writing';
            document.getElementById('nextPauseInfo').textContent = 'Write about what you just saw!';
            
            // Update mobile status
            const mobileStatus = document.getElementById('videoStatusMobile');
            if (mobileStatus) {
                mobileStatus.textContent = '‚è∏Ô∏è Paused for Writing';
            }
            
            updateCurrentPrompt();
            
            // Show resume button, hide pause button
            document.getElementById('pauseVideoButton').style.display = 'none';
            document.getElementById('resumeVideoButton').style.display = 'inline-block';
            
            // Focus on writing area
            setTimeout(() => {
                const storyInput = document.getElementById('storyInput') || document.getElementById('storyInputMobile');
                if (storyInput) {
                    storyInput.focus();
                }
            }, 100);
        }
        
        function saveStoryPart() {
            const storyInput = document.getElementById('storyInput') || document.getElementById('storyInputMobile');
            const storyPart = storyInput.value.trim();
            
            if (!storyPart) {
                alert('Please write something before saving this part!');
                return;
            }
            
            // Save the story part
            storyParts.push({
                part: currentPauseIndex + 1,
                content: storyPart,
                timestamp: currentVideoTime
            });
            
            // Clear the input
            storyInput.value = '';
            
            // Update the display
            updateStoryDisplay();
            
            // Move to next section
            currentPauseIndex++;
            
            // Resume video or finish
            if (currentVideoTime >= videoDuration || currentPauseIndex >= pauseTimes.length) {
                finishVideo();
            } else {
                resumeVideo();
            }
        }
        
        function resumeVideo() {
            videoPaused = false;
            
            // Resume the actual video if it's HTML5
            if (videoElement && videoElement.tagName === 'VIDEO') {
                videoElement.play();
            }
            
            document.getElementById('videoStatus').textContent = '‚ñ∂Ô∏è Video Playing';
            
            // Update mobile status
            const mobileStatus = document.getElementById('videoStatusMobile');
            if (mobileStatus) {
                mobileStatus.textContent = '‚ñ∂Ô∏è Video Playing';
            }
            
            // Show pause button, hide resume button
            document.getElementById('pauseVideoButton').style.display = 'inline-block';
            document.getElementById('resumeVideoButton').style.display = 'none';
            
            // Start countdown to next pause
            if (currentPauseIndex < pauseTimes.length) {
                const nextPauseTime = pauseTimes[currentPauseIndex];
                const timeUntilPause = nextPauseTime - currentVideoTime;
                document.getElementById('nextPauseInfo').textContent = `Next pause in ${timeUntilPause} seconds`;
                startCountdown();
            }
        }
        
        function pauseVideo() {
            // Manual pause
            if (videoElement && videoElement.tagName === 'VIDEO') {
                videoElement.pause();
            }
            pauseForWriting();
        }
        
        function finishVideo() {
            videoFinished = true;
            clearInterval(countdownTimer);
            
            document.getElementById('videoStatus').textContent = '‚úÖ Video Complete';
            document.getElementById('nextPauseInfo').textContent = 'Ready to review your story!';
            
            // Update mobile status
            const mobileStatus = document.getElementById('videoStatusMobile');
            if (mobileStatus) {
                mobileStatus.textContent = '‚úÖ Video Complete';
            }
            
            // Show finish button
            document.getElementById('pauseVideoButton').style.display = 'none';
            document.getElementById('resumeVideoButton').style.display = 'none';
            document.getElementById('finishVideoButton').style.display = 'inline-block';
            
            // If user has content in the input, save it
            const storyInput = document.getElementById('storyInput') || document.getElementById('storyInputMobile');
            if (storyInput && storyInput.value.trim()) {
                storyParts.push({
                    part: currentPauseIndex + 1,
                    content: storyInput.value.trim(),
                    timestamp: currentVideoTime
                });
                updateStoryDisplay();
            }
        }
        
        function updateStoryDisplay() {
            const partsContainer = document.getElementById('storyPartsList');
            const mobilePartsContainer = document.getElementById('storyPartsListMobile');
            
            const partsHTML = storyParts.map((part, index) => `
                <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #10b981;">
                    <div style="font-weight: 600; font-size: 0.9rem; color: #10b981; margin-bottom: 4px;">
                        Part ${part.part} (${Math.floor(part.timestamp/60)}:${(part.timestamp%60).toString().padStart(2, '0')})
                    </div>
                    <div style="font-size: 0.9rem; line-height: 1.4;">${part.content}</div>
                </div>
            `).join('');
            
            if (partsContainer) {
                partsContainer.innerHTML = partsHTML || '<div style="color: #9ca3af; font-style: italic;">No parts written yet...</div>';
            }
            
            if (mobilePartsContainer) {
                mobilePartsContainer.innerHTML = partsHTML || '<div style="color: #9ca3af; font-style: italic;">No parts written yet...</div>';
            }
            
            // Update progress
            document.getElementById('partsCount').textContent = storyParts.length;
            const progress = Math.min((storyParts.length / 6) * 100, 100);
            document.getElementById('storyProgress').style.width = `${progress}%`;
        }
        
        function reviewStory() {
            if (storyParts.length === 0) {
                alert('Please write at least one part of your story!');
                return;
            }
            
            stopTimer();
            
            // Combine all story parts into one narrative
            currentOriginalStory = storyParts.map(part => part.content).join('\n\n');
            
            displayFullStory();
            showPage('reviewPage');
        }
        
        function finishStory() {
            finishStoryFromVideo();
        }
        
        function displayFullStory() {
            document.getElementById('fullStory').textContent = currentOriginalStory;
            document.getElementById('editStory').value = currentOriginalStory;
            document.getElementById('finalStory').textContent = currentAIStory || currentOriginalStory;
        }
        
        async function sendToEditor() {
            const sendButton = document.getElementById('sendEditorButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending to Mentor...';
            
            showPage('waitingPage');
            
            try {
                const editorResponse = await callStoryForgeAPI(currentOriginalStory, 'mentor');
                
                document.getElementById('editorResponse').innerHTML = `
                    <div class="character-name">üìù Your Writing Mentor says:</div>
                    <p>${editorResponse}</p>
                `;
                
                document.getElementById('editStory').value = currentOriginalStory;
                document.getElementById('revisionButtons').style.display = 'block';
                document.getElementById('guildButtons').style.display = 'none';
                document.getElementById('guildSection').style.display = 'none';
                
                showNotification('üìù Your mentor has reviewed your story!');
                setTimeout(() => showPage('editorPage'), 2000);
                
            } catch (error) {
                console.error('Mentor API Error:', error);
                alert(`Unable to reach your writing mentor: ${error.message}`);
                showPage('reviewPage');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'üìù Send to Writing Mentor';
            }
        }
        
        async function submitRevision() {
            const revisedStory = document.getElementById('editStory').value.trim();
            
            if (!revisedStory) {
                alert('Please improve your story based on the mentor feedback!');
                return;
            }
            
            currentOriginalStory = revisedStory;
            
            showPage('waitingPage');
            document.querySelector('#waitingPage h2').textContent = 'üìù Mentor Reviewing Updates...';
            document.querySelector('#waitingPage p').textContent = 'Checking if your story is ready for the Guild!';
            
            try {
                const feedback = await callStoryForgeAPI(revisedStory, 'revision');
                
                // Check if mentor thinks it's ready for the Guild
                if (feedback.toLowerCase().includes('excellent') || feedback.toLowerCase().includes('ready') || feedback.toLowerCase().includes('guild')) {
                    const approvalResponse = await callStoryForgeAPI(revisedStory, 'approve_for_guild');
                    
                    document.getElementById('editorResponse').innerHTML = `
                        <div class="character-name">üìù Your Writing Mentor says:</div>
                        <p>${approvalResponse}</p>
                    `;
                    
                    document.getElementById('revisionButtons').style.display = 'none';
                    document.getElementById('guildButtons').style.display = 'block';
                    
                } else {
                    document.getElementById('editorResponse').innerHTML = `
                        <div class="character-name">üìù Your Writing Mentor responds:</div>
                        <p>${feedback}</p>
                    `;
                    
                    document.getElementById('editStory').value = revisedStory;
                }
                
                showNotification('üìù Mentor responded!');
                setTimeout(() => showPage('editorPage'), 2000);
                
            } catch (error) {
                console.error('Revision API Error:', error);
                alert(`Communication error with mentor: ${error.message}`);
                showPage('editorPage');
            }
        }
        
        async function sendToGuild() {
            showPage('waitingPage');
            
            document.querySelector('#waitingPage h2').textContent = '‚öíÔ∏è Guild Crafting Enhanced Story...';
            document.querySelector('#waitingPage p').textContent = 'The Storymakers Guild is expanding your story into something amazing!';
            
            try {
                const guildStory = await callStoryForgeAPI(currentOriginalStory, 'guild_story');
                currentAIStory = guildStory;
                
                document.getElementById('editorResponse').innerHTML = `
                    <div class="character-name">‚öíÔ∏è The Storymakers Guild presents:</div>
                    <div class="story-display" style="background: #f3e8ff; border-left: 5px solid #7c3aed;">
                        <p>${guildStory}</p>
                    </div>
                    <p><strong>What do you think of the Guild's enhanced version? Your feedback helps them improve!</strong></p>
                `;
                
                document.getElementById('editStory').value = '';
                document.getElementById('editStory').placeholder = 'Share your thoughts on the Guild version...';
                
                document.getElementById('revisionButtons').style.display = 'none';
                document.getElementById('guildButtons').style.display = 'none';
                document.getElementById('guildSection').style.display = 'block';
                
                showNotification('‚öíÔ∏è The Guild has enhanced your story!');
                setTimeout(() => showPage('editorPage'), 2000);
                
            } catch (error) {
                console.error('Guild Error:', error);
                alert(`The Guild is having trouble: ${error.message}`);
                showPage('editorPage');
            }
        }
        
        async function submitGuildFeedback() {
            const feedback = document.getElementById('editStory').value.trim();
            
            if (!feedback) {
                alert('Please share your thoughts on the Guild version!');
                return;
            }
            
            showPage('waitingPage');
            document.querySelector('#waitingPage h2').textContent = '‚öíÔ∏è Guild Considering Feedback...';
            document.querySelector('#waitingPage p').textContent = 'The Guild masters are reviewing your suggestions!';
            
            try {
                const guildResponse = await callStoryForgeAPI(feedback, 'guild_revision');
                
                document.getElementById('editorResponse').innerHTML = `
                    <div class="character-name">‚öíÔ∏è The Guild responds:</div>
                    <p>${guildResponse}</p>
                `;
                
                showNotification('üìù The Guild appreciated your feedback!');
                setTimeout(() => showPage('editorPage'), 2000);
                
            } catch (error) {
                console.error('Guild Feedback Error:', error);
                alert(`Communication error with Guild: ${error.message}`);
                showPage('editorPage');
            }
        }
        
        function keepStory() {
            showPage('successPage');
        }
        
        function finalizeStory() {
            showPage('successPage');
        }
        
        // Story saving functions
        async function saveStory(title, originalStory, aiStory = '') {
            try {
                const response = await fetch('/api/stories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        title: title || 'My Story',
                        originalStory,
                        aiEditedStory: aiStory,
                        videoUrl: 'https://www.youtube.com/embed/OvOrbWggMTs'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Story saved to your library! üìö');
                    return true;
                } else {
                    alert('Failed to save story. Please try again.');
                    return false;
                }
                
            } catch (error) {
                console.error('Error saving story:', error);
                alert('Failed to save story. Please try again.');
                return false;
            }
        }
        
        async function saveStoryAsIs() {
            const title = 'My Story Draft';
            const saved = await saveStory(title, currentOriginalStory, '');
            if (saved) {
                showPage('dashboardPage');
                loadDashboard();
            }
        }
        
        async function saveFinishedStory() {
            const title = document.getElementById('storyTitle').value.trim() || 'My Story';
            const saved = await saveStory(title, currentOriginalStory, currentAIStory);
            if (saved) {
                showPage('dashboardPage');
                loadDashboard();
            }
        }
        
        // Timer functions
        function startTimer() {
            document.getElementById('timer').style.display = 'block';
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.onclick = () => notification.remove();
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
        
        // Updated API call function for StoryForge narrative
        async function callStoryForgeAPI(storyText, mode) {
            let prompt;
            
            if (mode === 'mentor') {
                prompt = `You are a friendly Writing Mentor at the StoryForge Guild, helping young writers aged 8-16 improve their creative stories. Here's a story draft from one of your students: "${storyText}"

Respond as a supportive mentor with:
1. Start with encouragement about what they did well
2. Give 2-3 specific, gentle suggestions to improve their story (plot, characters, descriptions, dialogue)
3. Ask 1-2 questions to help them think deeper about their story
4. Keep it encouraging and age-appropriate (under 100 words)
5. Use simple, clear language that builds confidence

Focus on helping them improve THEIR story, not rewriting it yourself.`;

            } else if (mode === 'approve_for_guild') {
                prompt = `You are the Writing Mentor. The student has created this improved story: "${storyText}"

Respond as the mentor with:
1. Praise their improvements and hard work
2. Ask if they'd like the Storymakers Guild to create an enhanced version of their story
3. Explain that the Guild will expand their story into a longer, more detailed version
4. Keep it encouraging and under 80 words`;

            } else if (mode === 'guild_story') {
                prompt = `You are the Storymakers Guild, master storytellers who help young writers. A student has written this story: "${storyText}"

Create an enhanced version that:
1. Expands their story to 200-400 words
2. Keeps their original ideas and characters
3. Adds more descriptive details, dialogue, and plot development
4. Maintains their voice but makes it more engaging
5. Ensures it's age-appropriate and inspiring
6. Shows good story structure (beginning, middle, end)

Write the enhanced story, not a response to the student.`;

            } else if (mode === 'guild_revision') {
                prompt = `You are the Storymakers Guild responding to student feedback on your enhanced story.

Original student story: "${currentOriginalStory}"
Guild enhanced version: "${currentAIStory}"
Student feedback: "${storyText}"

Respond as the Guild with:
1. Thank them for their valuable feedback
2. Explain what you learned from their suggestions
3. Mention how you might adjust the story based on their input
4. Keep it encouraging and collaborative (under 80 words)`;

            } else {
                // This is the revision mode for the student's story
                prompt = `You are the Writing Mentor responding to the student's revised story: "${storyText}"

Original story: "${currentOriginalStory}"
Their revision: "${storyText}"

Give encouraging feedback and either:
- Suggest one small improvement and encourage another revision, OR
- Say their story is excellent and ready for the Guild to enhance

Keep it brief, positive, and under 70 words.`;
            }
            
            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 600
                }
            };
            
            const response = await fetch('/api/editor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Invalid response from AI service');
            }
            
            return data.candidates[0].content.parts[0].text;
        }
        
        // Setup event listeners
        window.addEventListener('load', async () => {
            console.log("Setting up StoryForge event listeners...");
            
            // Test server connection
            const statusElement = document.getElementById('connectionStatus');
            try {
                const response = await fetch('/health');
                const data = await response.json();
                console.log('‚úÖ Server connection OK:', data);
                statusElement.innerHTML = `<span style="color: #10b981;">‚úÖ Guild Ready</span>`;
            } catch (error) {
                console.error('‚ùå Server connection failed:', error);
                statusElement.innerHTML = `<span style="color: #dc2626;">‚ùå Guild Offline</span>`;
            }
            
            // Authentication event listeners
            document.getElementById('registerButton').addEventListener('click', registerUser);
            document.getElementById('loginButton').addEventListener('click', loginUser);
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // Navigation event listeners
            document.getElementById('newStoryButton').addEventListener('click', () => showPage('welcomePage'));
            document.getElementById('startButton').addEventListener('click', startStorySession);
            document.getElementById('backToDashboardButton').addEventListener('click', () => loadDashboard());
            document.getElementById('viewLibraryButton').addEventListener('click', () => loadDashboard());
            document.getElementById('createAnotherButton').addEventListener('click', () => showPage('welcomePage'));
            
            // Story flow event listeners
            document.getElementById('finishStoryButton').addEventListener('click', finishStoryFromVideo);
            document.getElementById('backToDashboardFromVideo').addEventListener('click', () => loadDashboard());
            document.getElementById('sendToGuildButton').addEventListener('click', sendToGuild);
            document.getElementById('keepStoryButton').addEventListener('click', keepStory);
            document.getElementById('submitGuildFeedbackButton').addEventListener('click', submitGuildFeedback);
            document.getElementById('approveGuildButton').addEventListener('click', () => showPage('successPage'));
            document.getElementById('sendEditorButton').addEventListener('click', sendToEditor);
            document.getElementById('saveStoryButton').addEventListener('click', saveStoryAsIs);
            document.getElementById('submitRevisionButton').addEventListener('click', submitRevision);
            document.getElementById('finalizeButton').addEventListener('click', finalizeStory);
            document.getElementById('saveFinishedStoryButton').addEventListener('click', saveFinishedStory);
            
            // Allow Enter key to submit name
            document.getElementById('firstNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerUser();
            });
            
            console.log("‚úÖ StoryForge ready!");
        });
        
        console.log("üé¨ StoryForge loaded successfully!");FinishedStory);FinishedStory);
            
            // Allow Enter key to submit name
            document.getElementById('firstNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerUser();
            });
            
            console.log("‚úÖ StoryForge ready!");
        });
        
        console.log("üé¨ StoryForge loaded successfully!");
    </script>
</body>
</html>
