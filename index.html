<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch.Right.Android - Story Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .page {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .page.active {
            display: block;
        }
        
        h1, h2 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            background: #ffd700;
            color: #333;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin: 10px;
        }
        
        button:hover {
            background: #ffed4e;
        }
        
        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        
        .video-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            resize: none;
            margin: 20px 0;
            box-sizing: border-box;
        }
        
        .pause-prompt {
            background: rgba(255, 215, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            margin: 20px 0;
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
        }
        
        .editor-response {
            background: rgba(147, 51, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #ffd700;
        }
        
        .character-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 18px;
        }
        
        .story-display {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .story-item {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .story-item:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
        }
        
        .story-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .story-preview {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .story-date {
            font-size: 12px;
            opacity: 0.6;
        }
        
        .timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 25px;
            font-family: monospace;
            font-size: 18px;
            display: none;
        }

        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            display: none;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .center {
            text-align: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="page active" id="loginPage">
        <h1>‚ú® Welcome to Story Creator ‚ú®</h1>
        <div class="login-form">
            <p>Create amazing stories with AI help!</p>
            
            <div id="loginSection">
                <h3>Already have an account?</h3>
                <button id="loginButton">üîê Login with Passkey</button>
            </div>
            
            <div id="registerSection">
                <h3>New here? Create an account!</h3>
                <input type="text" id="firstNameInput" placeholder="What's your first name?" maxlength="50">
                <br>
                <button id="registerButton">üöÄ Create Account with Passkey</button>
            </div>
            
            <div id="connectionStatus" class="status"></div>
            <p style="font-size: 12px; opacity: 0.7; margin-top: 30px;">
                üîí Your data stays private and secure on your device
            </p>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div class="page" id="dashboardPage">
        <div class="user-info" id="userInfo"></div>
        <h1>üìö Your Story Library</h1>
        
        <div class="center">
            <button id="newStoryButton">‚ú® Create New Story</button>
            <button id="logoutButton">üö™ Logout</button>
        </div>
        
        <div id="storiesContainer">
            <div id="loadingStories" class="center">Loading your stories...</div>
            <div id="noStories" class="center" style="display: none;">
                <p>No stories yet! Create your first masterpiece.</p>
            </div>
            <div id="storiesList"></div>
        </div>
    </div>

    <!-- Welcome Page (after login) -->
<div class="page" id="welcomePage">
    <div class="user-info" id="userInfoWelcome"></div>
    <h1>üëΩ Alien Research Station ‚ú®</h1>
    <div class="center">
        <p>Help aliens from Kepler-442b understand Earth by explaining YouTube videos!</p>
        <p><small>The aliens will then write their own story about what they learned.</small></p>
        <button id="startButton">Help the Aliens! üõ∏</button>
        <button id="backToDashboardButton">üìö Back to Library</button>
    </div>
</div>

  <!-- Video Page -->
<div class="page" id="videoPage">
    <div class="timer" id="timer">00:00</div>
    <div class="user-info" id="userInfoVideo"></div>
    <h2>üì∫ Aliens Sent This Video From Earth!</h2>
    <p style="text-align: center; opacity: 0.9;">They need your help understanding what's happening...</p>
    <div class="video-container">
        <iframe id="videoPlayer" width="100%" height="500" 
                src="https://www.youtube.com/embed/OvOrbWggMTs" 
                frameborder="0" allowfullscreen></iframe>
    </div>
    
    <div id="pausePrompt" class="pause-prompt">
        <h3>üõ∏ Alien Research Pause!</h3>
        <p id="pauseQuestion">Help the aliens understand: What just happened?</p>
        <textarea id="storyInput" placeholder="Explain to the aliens what you saw..."></textarea>
        <div class="center">
            <button id="continueButton">Continue Helping ‚ñ∂Ô∏è</button>
            <button id="finishButton">Send Explanation to Aliens! üì°</button>
        </div>
    </div>
</div>

   <!-- Story Review Page -->
<div class="page" id="reviewPage">
    <h2>üìñ Your Earth Explanation!</h2>
    <div id="fullStory" class="story-display"></div>
    <div class="center">
        <p>Ready to send your explanation to the alien researchers?</p>
        <button id="sendEditorButton">Send to Alien Researcher üëΩ</button>
        <button id="saveStoryButton">üíæ Save Explanation As-Is</button>
    </div>
</div>

    <!-- Waiting Page -->
    <div class="page" id="waitingPage">
        <h2>üßô‚Äç‚ôÇÔ∏è Editor is Working Magic...</h2>
        <div class="center">
            <p>Grammaticus is reading your story and preparing helpful suggestions!</p>
            <div style="font-size: 3em; animation: spin 2s linear infinite;">‚è≥</div>
            <p><small>This usually takes a few moments...</small></p>
        </div>
    </div>
<!-- Editor Response Page -->
<div class="page" id="editorPage">
    <h2>üì° Message from Kepler-442b!</h2>
    <div id="editorResponse" class="editor-response"></div>
    
    <div class="center">
        <button id="generateAlienStoryButton" style="background: #00ff00; color: #333;">
            üëΩ Ask Zyx-9 to Write Complete Story
        </button>
    </div>
    
    <div id="alienStorySection" style="display: none;">
        <h3>Give Feedback to Zyx-9:</h3>
        <textarea id="editStory" placeholder="Tell Zyx-9 what you think of their story..."></textarea>
        <div class="center">
            <button id="submitRevisionButton">Send Feedback to Aliens üì°</button>
            <button id="finalizeButton">Story is Perfect! üåü</button>
        </div>
    </div>
</div>

    <!-- Success Page -->
    <div class="page" id="successPage">
        <h1>üéâ Congratulations!</h1>
        <div class="center">
            <p>You've created an amazing story! Your writing skills are getting stronger every day.</p>
            <div id="finalStory" class="story-display"></div>
            <input type="text" id="storyTitle" placeholder="Give your story a title..." style="margin: 20px 0;">
            <br>
            <button id="saveFinishedStoryButton">üíæ Save to Library</button>
            <button id="createAnotherButton">üîÑ Create Another Story</button>
            <button id="viewLibraryButton">üìö View Library</button>
        </div>
    </div>

    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let storyParts = [];
        let pauseTimes = [15, 45, 75, 105]; // Change these pause times as needed
        let currentPauseIndex = 0;
        let sessionStartTime = Date.now();
        let timerInterval;
        let currentOriginalStory = '';
        let currentAIStory = '';
        
        // Simple page management
        function showPage(pageId) {
            console.log("Switching to page:", pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show the requested page
            document.getElementById(pageId).classList.add('active');
            
            // Update user info displays
            updateUserInfo();
        }
        
        function showAlienStorySection() {
                document.getElementById('generateAlienStoryButton').style.display = 'none';
                document.getElementById('alienStorySection').style.display = 'block';
        }

        function updateUserInfo() {
            if (currentUser) {
                const userDisplay = `üëã Hi ${currentUser.firstName}!`;
                document.getElementById('userInfo').textContent = userDisplay;
                document.getElementById('userInfoWelcome').textContent = userDisplay;
                document.getElementById('userInfoVideo').textContent = userDisplay;
                
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfoWelcome').style.display = 'block';
                document.getElementById('userInfoVideo').style.display = 'block';
            }
        }
        
        // Authentication functions
        async function registerUser() {
            const firstName = document.getElementById('firstNameInput').value.trim();
            
            if (!firstName) {
                alert('Please enter your first name');
                return;
            }
            
            if (firstName.length > 50) {
                alert('First name is too long');
                return;
            }
            
            try {
                // Check if WebAuthn is supported
                if (!window.PublicKeyCredential) {
                    alert('Passkeys are not supported on this device');
                    return;
                }
                
                document.getElementById('registerButton').disabled = true;
                document.getElementById('registerButton').textContent = 'Creating Account...';
                
                // Start registration
                const beginResponse = await fetch('/api/auth/register/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName })
                });
                
                const { options, userId } = await beginResponse.json();
                
                // Create credential
                const credential = await SimpleWebAuthnBrowser.startRegistration(options);
                
                // Complete registration
                const completeResponse = await fetch('/api/auth/register/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, firstName, credential })
                });
                
                const result = await completeResponse.json();
                
                if (result.verified) {
                    currentUser = result.user;
                    showNotification('Account created successfully! üéâ');
                    await loadDashboard();
                } else {
                    alert('Account creation failed. Please try again.');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                alert('Account creation failed. Please try again.');
            } finally {
                document.getElementById('registerButton').disabled = false;
                document.getElementById('registerButton').textContent = 'üöÄ Create Account with Passkey';
            }
        }
        
        async function loginUser() {
            try {
                if (!window.PublicKeyCredential) {
                    alert('Passkeys are not supported on this device');
                    return;
                }
                
                document.getElementById('loginButton').disabled = true;
                document.getElementById('loginButton').textContent = 'Logging in...';
                
                // Start authentication
                const beginResponse = await fetch('/api/auth/login/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const options = await beginResponse.json();
                
                // Authenticate with passkey
                const credential = await SimpleWebAuthnBrowser.startAuthentication(options);
                
                // Complete authentication
                const completeResponse = await fetch('/api/auth/login/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential })
                });
                
                const result = await completeResponse.json();
                
                if (result.verified) {
                    currentUser = result.user;
                    showNotification(`Welcome back, ${currentUser.firstName}! üëã`);
                    await loadDashboard();
                } else {
                    alert('Login failed. Please try again.');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                if (error.name === 'NotAllowedError') {
                    alert('Login was cancelled or failed. Please try again.');
                } else {
                    alert('Login failed. Please try again.');
                }
            } finally {
                document.getElementById('loginButton').disabled = false;
                document.getElementById('loginButton').textContent = 'üîê Login with Passkey';
            }
        }
        
        function logout() {
            currentUser = null;
            showPage('loginPage');
            showNotification('Logged out successfully! üëã');
        }
        
        // Dashboard functions
        async function loadDashboard() {
            showPage('dashboardPage');
            
            try {
                const response = await fetch(`/api/stories/${currentUser.id}`);
                const data = await response.json();
                
                displayStories(data.stories);
                
            } catch (error) {
                console.error('Error loading stories:', error);
                document.getElementById('loadingStories').textContent = 'Error loading stories';
            }
        }
        
        function displayStories(stories) {
            const container = document.getElementById('storiesList');
            const loading = document.getElementById('loadingStories');
            const noStories = document.getElementById('noStories');
            
            loading.style.display = 'none';
            
            if (!stories || stories.length === 0) {
                noStories.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            noStories.style.display = 'none';
            
            container.innerHTML = stories.map(story => {
                const preview = (story.ai_edited_story || story.original_story).substring(0, 100) + '...';
                const date = new Date(story.created_at).toLocaleDateString();
                
                return `
                    <div class="story-item" onclick="viewStory('${story.id}', '${story.title}', '${story.original_story}', '${story.ai_edited_story || ''}')">
                        <div class="story-title">${story.title}</div>
                        <div class="story-preview">${preview}</div>
                        <div class="story-date">Created: ${date}</div>
                    </div>
                `;
            }).join('');
        }
        
        function viewStory(id, title, originalStory, aiStory) {
            // Show story in a simple view
            const storyContent = aiStory || originalStory;
            alert(`${title}\n\n${storyContent}`);
        }
        
        // Story saving functions
        async function saveStory(title, originalStory, aiStory = '') {
            try {
                const response = await fetch('/api/stories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        title: title || 'My Story',
                        originalStory,
                        aiEditedStory: aiStory,
                        videoUrl: 'https://www.youtube.com/embed/OvOrbWggMTs'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Story saved to your library! üìö');
                    return true;
                } else {
                    alert('Failed to save story. Please try again.');
                    return false;
                }
                
            } catch (error) {
                console.error('Error saving story:', error);
                alert('Failed to save story. Please try again.');
                return false;
            }
        }
        
        // Timer functions
        function startTimer() {
            document.getElementById('timer').style.display = 'block';
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
        }
        
        // Story flow functions
        function startStorySession() {
            console.log("Starting story session...");
            storyParts = [];
            currentPauseIndex = 0;
            sessionStartTime = Date.now();
            showPage('videoPage');
            startTimer();
            setTimeout(() => pauseVideo(), pauseTimes[0] * 1000);
        }
        
        function pauseVideo() {
            console.log("Pausing video for input...");
            const questions = [
                "What happened in the beginning of the story?",
                "Who are the main characters and what are they doing?",
                "What problem or challenge appeared?",
                "How do you think the story will end?"
            ];
            
            document.getElementById('pauseQuestion').textContent = 
                questions[currentPauseIndex] || "What just happened?";
            document.getElementById('pausePrompt').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('storyInput').focus();
            }, 100);
        }
        
        function continueVideo() {
            const storyPart = document.getElementById('storyInput').value.trim();
            if (!storyPart) {
                alert('Please write something about what happened!');
                return;
            }
            
            storyParts.push(storyPart);
            document.getElementById('storyInput').value = '';
            document.getElementById('pausePrompt').style.display = 'none';
            
            currentPauseIndex++;
            if (currentPauseIndex < pauseTimes.length) {
                const nextPause = pauseTimes[currentPauseIndex] - pauseTimes[currentPauseIndex - 1];
                setTimeout(() => pauseVideo(), nextPause * 1000);
            } else {
                setTimeout(() => {
                    document.getElementById('pauseQuestion').textContent = "How did the story end?";
                    document.getElementById('pausePrompt').style.display = 'block';
                }, 30000);
            }
        }
        
        function finishStory() {
            const finalPart = document.getElementById('storyInput').value.trim();
            if (finalPart) {
                storyParts.push(finalPart);
            }
            
            if (storyParts.length === 0) {
                alert('Please write at least one part of the story!');
                return;
            }
            
            stopTimer();
            currentOriginalStory = storyParts.join(' ');
            displayFullStory();
            showPage('reviewPage');
        }
        
        function displayFullStory() {
            document.getElementById('fullStory').textContent = currentOriginalStory;
            document.getElementById('editStory').value = currentOriginalStory;
            document.getElementById('finalStory').textContent = currentAIStory || currentOriginalStory;
        }
        
     async function sendToEditor() {
    const sendButton = document.getElementById('sendEditorButton');
    sendButton.disabled = true;
    sendButton.textContent = 'Sending to Zyx-9...';
    
    showPage('waitingPage');
    
    // Update waiting page text
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Alien Researcher Analyzing...';
    document.querySelector('#waitingPage p').textContent = 'Zyx-9 is studying your explanation of Earth customs!';
    
    try {
        const editorResponse = await callGeminiAPI(currentOriginalStory, 'editor');
        
        document.getElementById('editorResponse').innerHTML = `
            <div class="character-name">üëΩ Zyx-9 from Kepler-442b says:</div>
            <p>${editorResponse}</p>
        `;
        
        showNotification('üì° Message from the aliens!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Alien API Error:', error);
        alert(`The aliens are having communication issues: ${error.message}`);
        showPage('reviewPage');
    } finally {
        sendButton.disabled = false;
        sendButton.textContent = 'Send to Alien Researcher üëΩ';
    }
}
        
        async function submitRevision() {
    const revisedStory = document.getElementById('editStory').value;
    
    if (!revisedStory.trim()) {
        alert('Please give feedback to help the aliens understand!');
        return;
    }
    
    showPage('waitingPage');
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Processing Your Feedback...';
    document.querySelector('#waitingPage p').textContent = 'Zyx-9 is learning from your suggestions!';
    
    try {
        const feedback = await callGeminiAPI(revisedStory, 'revision');
        
        document.getElementById('editorResponse').innerHTML = `
            <div class="character-name">üëΩ Zyx-9 responds:</div>
            <p>${feedback}</p>
        `;
        
        showNotification('üì° Zyx-9 responded to your feedback!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Revision API Error:', error);
        alert(`Communication error with aliens: ${error.message}`);
        showPage('editorPage');
    }
}
        
        function finalizeStory() {
            currentAIStory = document.getElementById('editStory').value;
            document.getElementById('finalStory').textContent = currentAIStory;
            showPage('successPage');
        }
        
        async function saveStoryAsIs() {
            const saved = await saveStory('My Story', currentOriginalStory, '');
            if (saved) {
                showPage('dashboardPage');
                loadDashboard();
            }
        }
        
        // Add this new function for generating the alien story
async function generateAlienStory() {
    showPage('waitingPage');
    
    // Update waiting page for story generation
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Zyx-9 Writing Earth Story...';
    document.querySelector('#waitingPage p').textContent = 'The alien researcher is writing a complete story about what they learned!';
    
    try {
        const alienStoryResponse = await callGeminiAPI(currentOriginalStory, 'alien_story');
        currentAIStory = alienStoryResponse;
        
        // Update the editor page to show the alien story
        document.getElementById('editorResponse').innerHTML = `
            <div class="character-name">üëΩ Zyx-9's Complete Earth Story:</div>
            <div class="story-display" style="background: rgba(100, 255, 100, 0.1); border-left: 5px solid #00ff00;">
                <p>${alienStoryResponse}</p>
            </div>
            <p><strong>What do you think of Zyx-9's story? You can give feedback to help the aliens understand Earth better!</strong></p>
        `;
        
        // Update the textarea with the alien story for editing
        document.getElementById('editStory').value = alienStoryResponse;
        document.getElementById('editStory').placeholder = 'Give feedback to Zyx-9 about their Earth story...';
        
        // Show the feedback section
        showAlienStorySection();
        
        showNotification('üëΩ Zyx-9 wrote a complete story!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Alien Story Error:', error);
        alert(`The aliens had trouble writing the story: ${error.message}`);
        showPage('editorPage');
    }
}

        async function saveFinishedStory() {
            const title = document.getElementById('storyTitle').value.trim() || 'My Story';
            const saved = await saveStory(title, currentOriginalStory, currentAIStory);
            if (saved) {
                showPage('dashboardPage');
                loadDashboard();
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.onclick = () => notification.remove();
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
        
// API call function
async function callGeminiAPI(storyText, mode) {
    let prompt;
    if (mode === 'editor') {
        prompt = `You are Zyx-9, a friendly alien researcher from the planet Kepler-442b. You and your fellow aliens are studying Earth by watching human "YouTube videos" but you need help understanding what you're seeing.

A human child just helped you understand this video by writing: "${storyText}"

Respond as Zyx-9 with:
1. Thank them for helping you understand Earth
2. Ask 2-3 curious alien questions about what they observed
3. Offer to write a full story about what you learned for their Earth friends
4. Keep it encouraging and under 80 words
5. Use slightly alien but friendly language

Example: "Fascinating! Your explanation helps us understand human [behavior/customs/etc]. We are curious - why do humans [question]? Would you like me to write a complete story about this for other Earth children to read?"`;
    } else if (mode === 'alien_story') {
        prompt = `You are Zyx-9, an alien researcher writing a complete story for Earth children based on what you learned from a human child's explanation: "${storyText}"

Write a longer, detailed story (200-400 words) that:
1. Tells the story from an alien perspective trying to understand Earth
2. Includes what you learned from the child's explanation
3. Makes it educational and entertaining for children
4. Shows how aliens might misunderstand but then learn about human life
5. Ends with appreciation for human culture

Write in a storytelling voice, not as a response to the child.`;
    } else {
        prompt = `You are Zyx-9, an alien researcher responding to a child's feedback on your story. 

Original human explanation: "${currentOriginalStory}"
Your alien story: "${storyText}"

Give encouraging feedback on their suggestions and either:
- Thank them for helping you understand Earth better, OR
- Ask if they'd like you to revise the story based on their feedback

Keep it brief, alien-friendly, and supportive (under 60 words).`;
    }
    
    const requestBody = {
        contents: [{
            parts: [{ text: prompt }]
        }],
        generationConfig: {
            temperature: 0.8,
            maxOutputTokens: 400
        }
    };
    
    const response = await fetch('/api/editor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `Server error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
        throw new Error('Invalid response from AI service');
    }
    
    return data.candidates[0].content.parts[0].text;
}
        
        // Setup event listeners when page loads
        window.addEventListener('load', async () => {
            console.log("Setting up event listeners...");
            
            // Test server connection
            const statusElement = document.getElementById('connectionStatus');
            try {
                const response = await fetch('/health');
                const data = await response.json();
                console.log('‚úÖ Server connection OK:', data);
                statusElement.innerHTML = `<span style="color: #28a745;">‚úÖ Server Ready</span>`;
            } catch (error) {
                console.error('‚ùå Server connection failed:', error);
                statusElement.innerHTML = `<span style="color: #dc3545;">‚ùå Server Issue</span>`;
            }
            
            // Authentication event listeners
            document.getElementById('registerButton').addEventListener('click', registerUser);
            document.getElementById('loginButton').addEventListener('click', loginUser);
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // Navigation event listeners
            document.getElementById('newStoryButton').addEventListener('click', () => showPage('welcomePage'));
            document.getElementById('startButton').addEventListener('click', startStorySession);
            document.getElementById('backToDashboardButton').addEventListener('click', () => loadDashboard());
            document.getElementById('viewLibraryButton').addEventListener('click', () => loadDashboard());
            document.getElementById('createAnotherButton').addEventListener('click', () => showPage('welcomePage'));
            
            // Story flow event listeners
            document.getElementById('continueButton').addEventListener('click', continueVideo);
            document.getElementById('finishButton').addEventListener('click', finishStory);
            document.getElementById('sendEditorButton').addEventListener('click', sendToEditor);
            document.getElementById('saveStoryButton').addEventListener('click', saveStoryAsIs);
            document.getElementById('submitRevisionButton').addEventListener('click', submitRevision);
            document.getElementById('finalizeButton').addEventListener('click', finalizeStory);
            document.getElementById('saveFinishedStoryButton').addEventListener('click', saveFinishedStory);
            document.getElementById('generateAlienStoryButton').addEventListener('click', generateAlienStory);
            
            // Allow Enter key to submit first name
            document.getElementById('firstNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerUser();
            });
            
            console.log("‚úÖ All event listeners ready!");
        });
        
        console.log("üé¨ Story Creator with Authentication loaded!");
    </script>
</body>
</html>