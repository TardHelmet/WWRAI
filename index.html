<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch.Right.Android - Story Creator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .page {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .page.active {
            display: block;
        }
        
        h1, h2 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            background: #ffd700;
            color: #333;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin: 10px;
        }
        
        button:hover {
            background: #ffed4e;
        }
        
        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        
        .video-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            resize: none;
            margin: 20px 0;
            box-sizing: border-box;
        }
        
        .pause-prompt {
            background: rgba(255, 215, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            margin: 20px 0;
            display: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
        }
        
        .editor-response {
            background: rgba(147, 51, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #ffd700;
        }
        
        .character-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 18px;
        }
        
        .story-display {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .story-item {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .story-item:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
        }
        
        .story-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .story-preview {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .story-date {
            font-size: 12px;
            opacity: 0.6;
        }
        
        .timer {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 25px;
            font-family: monospace;
            font-size: 18px;
            display: none;
        }

        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            display: none;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .center {
            text-align: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="page active" id="loginPage">
        <h1>‚ú® Welcome to Story Creator ‚ú®</h1>
        <div class="login-form">
            <p>Create amazing stories with AI help!</p>
            
            <div id="loginSection">
                <h3>Already have an account?</h3>
                <button id="loginButton">üîê Login with Passkey</button>
            </div>
            
            <div id="registerSection">
                <h3>New here? Create an account!</h3>
                <input type="text" id="firstNameInput" placeholder="What's your first name?" maxlength="50">
                <br>
                <button id="registerButton">üöÄ Create Account with Passkey</button>
            </div>
            
            <div id="connectionStatus" class="status"></div>
            <p style="font-size: 12px; opacity: 0.7; margin-top: 30px;">
                üîí Your data stays private and secure on your device
            </p>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div class="page" id="dashboardPage">
        <div class="user-info" id="userInfo"></div>
        <h1>üìö Your Story Library</h1>
        
        <div class="center">
            <button id="newStoryButton">‚ú® Create New Story</button>
            <button id="logoutButton">üö™ Logout</button>
        </div>
        
        <div id="storiesContainer">
            <div id="loadingStories" class="center">Loading your stories...</div>
            <div id="noStories" class="center" style="display: none;">
                <p>No stories yet! Create your first masterpiece.</p>
            </div>
            <div id="storiesList"></div>
        </div>
    </div>

    <!-- Welcome Page (after login) -->
<div class="page" id="welcomePage">
    <div class="user-info" id="userInfoWelcome"></div>
    <h1>üëΩ Alien Research Station ‚ú®</h1>
    <div class="center">
        <p>Help aliens from Kepler-442b understand Earth by explaining YouTube videos!</p>
        <p><small>The aliens will then write their own story about what they learned.</small></p>
        <button id="startButton">Help the Aliens! üõ∏</button>
        <button id="backToDashboardButton">üìö Back to Library</button>
    </div>
</div>

  <!-- Video Page -->
<div class="page" id="videoPage">
    <div class="timer" id="timer">00:00</div>
    <div class="user-info" id="userInfoVideo"></div>
    <h2>üì∫ Aliens Sent This Video From Earth!</h2>
    <p style="text-align: center; opacity: 0.9;">They need your help understanding what's happening...</p>
    <div class="video-container">
        <iframe id="videoPlayer" width="100%" height="500" 
                src="https://www.youtube.com/embed/OvOrbWggMTs" 
                frameborder="0" allowfullscreen></iframe>
    </div>
    
    <div id="pausePrompt" class="pause-prompt">
        <h3>üõ∏ Alien Research Pause!</h3>
        <p id="pauseQuestion">Help the aliens understand: What just happened?</p>
        <textarea id="storyInput" placeholder="Explain to the aliens what you saw..."></textarea>
        <div class="center">
            <button id="continueButton">Continue Helping ‚ñ∂Ô∏è</button>
            <button id="finishButton">Send Explanation to Aliens! üì°</button>
        </div>
    </div>
</div>

   <!-- Story Review Page -->
<div class="page" id="reviewPage">
    <h2>üìñ Your Earth Explanation!</h2>
    <div id="fullStory" class="story-display"></div>
    <div class="center">
        <p>Ready to send your explanation to the alien researchers?</p>
        <button id="sendEditorButton">Send to Alien Researcher üëΩ</button>
        <button id="saveStoryButton">üíæ Save Explanation As-Is</button>
    </div>
</div>

    <!-- Waiting Page -->
    <div class="page" id="waitingPage">
        <h2>üßô‚Äç‚ôÇÔ∏è Editor is Working Magic...</h2>
        <div class="center">
            <p>Grammaticus is reading your story and preparing helpful suggestions!</p>
            <div style="font-size: 3em; animation: spin 2s linear infinite;">‚è≥</div>
            <p><small>This usually takes a few moments...</small></p>
        </div>
    </div>

<!-- Editor Response Page -->
<div class="page" id="editorPage">
    <h2>üì° Message from Kepler-442b!</h2>
    <div id="editorResponse" class="editor-response"></div>
    
    <h3>Your Explanation:</h3>
    <textarea id="editStory" placeholder="Improve your explanation..."></textarea>
    
    <!-- Buttons for improving the kid's explanation -->
    <div id="revisionButtons" class="center" style="display: none;">
        <button id="submitRevisionButton">Send Updated Explanation üì°</button>
        <button id="finalizeButton">My Explanation is Perfect! ‚≠ê</button>
    </div>
    
    <!-- Buttons for sending to top researcher -->
    <div id="researcherButtons" class="center" style="display: none;">
        <button id="sendToResearcherButton" style="background: #00ff00; color: #333;">
            üëΩ Send to Dr. Qorinth (Top Researcher)
        </button>
        <button id="declineResearcherButton" style="background: #ff6b6b; color: white;">
            üìö Keep My Explanation As-Is
        </button>
    </div>
    
    <!-- Section for researcher feedback -->
    <div id="researcherSection" style="display: none;">
        <div class="center">
            <button id="submitResearcherFeedbackButton">Send Feedback to Dr. Qorinth üì°</button>
            <button id="approveResearchButton">Research Report is Perfect! üåü</button>
        </div>
    </div>
</div>

    <!-- Success Page -->
    <div class="page" id="successPage">
        <h1>üéâ Congratulations!</h1>
        <div class="center">
            <p>You've created an amazing story! Your writing skills are getting stronger every day.</p>
            <div id="finalStory" class="story-display"></div>
            <input type="text" id="storyTitle" placeholder="Give your story a title..." style="margin: 20px 0;">
            <br>
            <button id="saveFinishedStoryButton">üíæ Save to Library</button>
            <button id="createAnotherButton">üîÑ Create Another Story</button>
            <button id="viewLibraryButton">üìö View Library</button>
        </div>
    </div>

    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <script>
        console.log('üé¨ Script starting to load...');
        // Global variables
        let currentUser = null;
        let storyParts = [];
        let pauseTimes = [15, 45, 75, 105]; // Change these pause times as needed
        let currentPauseIndex = 0;
        let sessionStartTime = Date.now();
        let timerInterval;
        let currentOriginalStory = '';
        let currentAIStory = '';
        
        // Simple page management
        function showPage(pageId) {
            console.log("Switching to page:", pageId);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show the requested page
            document.getElementById(pageId).classList.add('active');
            
            // Update user info displays
            updateUserInfo();
        }
        
        function showAlienStorySection() {
                document.getElementById('generateAlienStoryButton').style.display = 'none';
                document.getElementById('alienStorySection').style.display = 'block';
        }

async function saveStoryAsIs() {
    const title = 'My Earth Explanation';
    const saved = await saveStory(title, currentOriginalStory, '');
    if (saved) {
        showPage('dashboardPage');
        loadDashboard();
    }
}

function finalizeStory() {
    // User is happy with their explanation, go to success page
    showPage('successPage');
}
        function updateUserInfo() {
            if (currentUser) {
                const userDisplay = `üëã Hi ${currentUser.firstName}!`;
                document.getElementById('userInfo').textContent = userDisplay;
                document.getElementById('userInfoWelcome').textContent = userDisplay;
                document.getElementById('userInfoVideo').textContent = userDisplay;
                
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userInfoWelcome').style.display = 'block';
                document.getElementById('userInfoVideo').style.display = 'block';
            }
        }
        
        // Authentication functions
        async function registerUser() {
    console.log('üöÄ Register button clicked!');
    
    const firstName = document.getElementById('firstNameInput').value.trim();
    console.log('üìù First name entered:', firstName);
    
    if (!firstName) {
        console.log('‚ùå No first name provided');
        alert('Please enter your first name');
        return;
    }
    
    if (firstName.length > 50) {
        console.log('‚ùå First name too long');
        alert('First name is too long');
        return;
    }
    
    try {
        console.log('üîç Checking WebAuthn support...');
        // Check if WebAuthn is supported
        if (!window.PublicKeyCredential) {
            console.log('‚ùå WebAuthn not supported');
            alert('Passkeys are not supported on this device');
            return;
        }
        console.log('‚úÖ WebAuthn supported');
        
        console.log('üîÑ Disabling button...');
        document.getElementById('registerButton').disabled = true;
        document.getElementById('registerButton').textContent = 'Creating Account...';
        
        console.log('üì° Making request to /api/auth/register/begin...');
        
        // Start registration
        const beginResponse = await fetch('/api/auth/register/begin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ firstName })
        });
        
        console.log('üì° Begin response status:', beginResponse.status);
        
        if (!beginResponse.ok) {
            const errorText = await beginResponse.text();
            console.log('‚ùå Begin response error:', errorText);
            throw new Error(`Server error: ${beginResponse.status}`);
        }
        
        const { options, userId } = await beginResponse.json();
        console.log('‚úÖ Begin response received, userId:', userId);
        
        console.log('üîê Starting passkey creation...');
        // Create credential
        const credential = await SimpleWebAuthnBrowser.startRegistration(options);
        console.log('‚úÖ Passkey created successfully');
        
        console.log('üì° Completing registration...');
        // Complete registration
        const completeResponse = await fetch('/api/auth/register/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, firstName, credential })
        });
        
        console.log('üì° Complete response status:', completeResponse.status);
        
        const result = await completeResponse.json();
        console.log('üì° Complete response:', result);
        
        if (result.verified) {
            console.log('üéâ Registration successful!');
            currentUser = result.user;
            showNotification('Account created successfully! üéâ');
            await loadDashboard();
        } else {
            console.log('‚ùå Registration verification failed');
            alert('Account creation failed. Please try again.');
        }
        
    } catch (error) {
        console.error('üí• Registration error:', error);
        alert(`Account creation failed: ${error.message}`);
    } finally {
        console.log('üîÑ Re-enabling button...');
        document.getElementById('registerButton').disabled = false;
        document.getElementById('registerButton').textContent = 'üöÄ Create Account with Passkey';
    }
}
        
        async function loginUser() {
            try {
                if (!window.PublicKeyCredential) {
                    alert('Passkeys are not supported on this device');
                    return;
                }
                
                document.getElementById('loginButton').disabled = true;
                document.getElementById('loginButton').textContent = 'Logging in...';
                
                // Start authentication
                const beginResponse = await fetch('/api/auth/login/begin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const options = await beginResponse.json();
                
                // Authenticate with passkey
                const credential = await SimpleWebAuthnBrowser.startAuthentication(options);
                
                // Complete authentication
                const completeResponse = await fetch('/api/auth/login/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential })
                });
                
                const result = await completeResponse.json();
                
                if (result.verified) {
                    currentUser = result.user;
                    showNotification(`Welcome back, ${currentUser.firstName}! üëã`);
                    await loadDashboard();
                } else {
                    alert('Login failed. Please try again.');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                if (error.name === 'NotAllowedError') {
                    alert('Login was cancelled or failed. Please try again.');
                } else {
                    alert('Login failed. Please try again.');
                }
            } finally {
                document.getElementById('loginButton').disabled = false;
                document.getElementById('loginButton').textContent = 'üîê Login with Passkey';
            }
        }
        
        function logout() {
            currentUser = null;
            showPage('loginPage');
            showNotification('Logged out successfully! üëã');
        }
        
        // Dashboard functions
        async function loadDashboard() {
            showPage('dashboardPage');
            
            try {
                const response = await fetch(`/api/stories/${currentUser.id}`);
                const data = await response.json();
                
                displayStories(data.stories);
                
            } catch (error) {
                console.error('Error loading stories:', error);
                document.getElementById('loadingStories').textContent = 'Error loading stories';
            }
        }
        
        function displayStories(stories) {
            const container = document.getElementById('storiesList');
            const loading = document.getElementById('loadingStories');
            const noStories = document.getElementById('noStories');
            
            loading.style.display = 'none';
            
            if (!stories || stories.length === 0) {
                noStories.style.display = 'block';
                container.innerHTML = '';
                return;
            }
            
            noStories.style.display = 'none';
            
            container.innerHTML = stories.map(story => {
                const preview = (story.ai_edited_story || story.original_story).substring(0, 100) + '...';
                const date = new Date(story.created_at).toLocaleDateString();
                
                return `
                    <div class="story-item" onclick="viewStory('${story.id}', '${story.title}', '${story.original_story}', '${story.ai_edited_story || ''}')">
                        <div class="story-title">${story.title}</div>
                        <div class="story-preview">${preview}</div>
                        <div class="story-date">Created: ${date}</div>
                    </div>
                `;
            }).join('');
        }
        
        function viewStory(id, title, originalStory, aiStory) {
            // Show story in a simple view
            const storyContent = aiStory || originalStory;
            alert(`${title}\n\n${storyContent}`);
        }
        
async function sendToResearcher() {
    showPage('waitingPage');
    
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Dr. Qorinth Writing Research Report...';
    document.querySelector('#waitingPage p').textContent = 'The top alien researcher is creating a detailed report about Earth!';
    
    try {
        const researchReport = await callGeminiAPI(currentOriginalStory, 'researcher_story');
        currentAIStory = researchReport;
        
        document.getElementById('editorResponse').innerHTML = `
            <div class="character-name">üëΩ Dr. Qorinth's Research Report:</div>
            <div class="story-display" style="background: rgba(100, 255, 100, 0.1); border-left: 5px solid #00ff00;">
                <p>${researchReport}</p>
            </div>
            <p><strong>What do you think of Dr. Qorinth's research report? Your feedback will help improve alien understanding of Earth!</strong></p>
        `;
        
        // Show the research report for feedback
        document.getElementById('editStory').value = '';
        document.getElementById('editStory').placeholder = 'Give feedback to Dr. Qorinth about the research report...';
        
        // Show researcher feedback section
        document.getElementById('revisionButtons').style.display = 'none';
        document.getElementById('researcherButtons').style.display = 'none';
        document.getElementById('researcherSection').style.display = 'block';
        
        showNotification('üëΩ Dr. Qorinth completed the research report!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Researcher Error:', error);
        alert(`Dr. Qorinth had trouble writing the report: ${error.message}`);
        showPage('editorPage');
    }
}

// New function - Submit feedback to researcher
async function submitResearcherFeedback() {
    const feedback = document.getElementById('editStory').value.trim();
    
    if (!feedback) {
        alert('Please give feedback to Dr. Qorinth about the research report!');
        return;
    }
    
    showPage('waitingPage');
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Dr. Qorinth Processing Feedback...';
    document.querySelector('#waitingPage p').textContent = 'The researcher is considering your suggestions!';
    
    try {
        const researcherResponse = await callGeminiAPI(feedback, 'researcher_revision');
        
        document.getElementById('editorResponse').innerHTML = `
            <div class="character-name">üëΩ Dr. Qorinth responds:</div>
            <p>${researcherResponse}</p>
        `;
        
        // Update the AI story if the researcher revised it
        // For this demo, we'll keep the original report
        
        showNotification('üì° Dr. Qorinth appreciated your feedback!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Researcher Feedback Error:', error);
        alert(`Communication error with Dr. Qorinth: ${error.message}`);
        showPage('editorPage');
    }
}

function declineResearcher() {
    alert('No problem! You can always ask Zyx-9 to send your explanation to Dr. Qorinth later.');
    showPage('successPage');
}
        // Story saving functions
        async function saveStory(title, originalStory, aiStory = '') {
            try {
                const response = await fetch('/api/stories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        title: title || 'My Story',
                        originalStory,
                        aiEditedStory: aiStory,
                        videoUrl: 'https://www.youtube.com/embed/OvOrbWggMTs'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Story saved to your library! üìö');
                    return true;
                } else {
                    alert('Failed to save story. Please try again.');
                    return false;
                }
                
            } catch (error) {
                console.error('Error saving story:', error);
                alert('Failed to save story. Please try again.');
                return false;
            }
        }
        
        // Timer functions
        function startTimer() {
            document.getElementById('timer').style.display = 'block';
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
        }
        
        // Story flow functions
        function startStorySession() {
            console.log("Starting story session...");
            storyParts = [];
            currentPauseIndex = 0;
            sessionStartTime = Date.now();
            showPage('videoPage');
            startTimer();
            setTimeout(() => pauseVideo(), pauseTimes[0] * 1000);
        }
        
        function pauseVideo() {
            console.log("Pausing video for input...");
            const questions = [
                "What happened in the beginning of the story?",
                "Who are the main characters and what are they doing?",
                "What problem or challenge appeared?",
                "How do you think the story will end?"
            ];
            
            document.getElementById('pauseQuestion').textContent = 
                questions[currentPauseIndex] || "What just happened?";
            document.getElementById('pausePrompt').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('storyInput').focus();
            }, 100);
        }
        
        function continueVideo() {
            const storyPart = document.getElementById('storyInput').value.trim();
            if (!storyPart) {
                alert('Please write something about what happened!');
                return;
            }
            
            storyParts.push(storyPart);
            document.getElementById('storyInput').value = '';
            document.getElementById('pausePrompt').style.display = 'none';
            
            currentPauseIndex++;
            if (currentPauseIndex < pauseTimes.length) {
                const nextPause = pauseTimes[currentPauseIndex] - pauseTimes[currentPauseIndex - 1];
                setTimeout(() => pauseVideo(), nextPause * 1000);
            } else {
                setTimeout(() => {
                    document.getElementById('pauseQuestion').textContent = "How did the story end?";
                    document.getElementById('pausePrompt').style.display = 'block';
                }, 30000);
            }
        }
        
        function finishStory() {
            const finalPart = document.getElementById('storyInput').value.trim();
            if (finalPart) {
                storyParts.push(finalPart);
            }
            
            if (storyParts.length === 0) {
                alert('Please write at least one part of the story!');
                return;
            }
            
            stopTimer();
            currentOriginalStory = storyParts.join(' ');
            displayFullStory();
            showPage('reviewPage');
        }
        
        function displayFullStory() {
            document.getElementById('fullStory').textContent = currentOriginalStory;
            document.getElementById('editStory').value = currentOriginalStory;
            document.getElementById('finalStory').textContent = currentAIStory || currentOriginalStory;
        }
        
    async function sendToEditor() {
    const sendButton = document.getElementById('sendEditorButton');
    sendButton.disabled = true;
    sendButton.textContent = 'Sending to Zyx-9...';
    
    showPage('waitingPage');
    
    // Update waiting page text
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Zyx-9 Reviewing Your Explanation...';
    document.querySelector('#waitingPage p').textContent = 'The alien researcher is helping you improve your explanation!';
    
    try {
        const editorResponse = await callGeminiAPI(currentOriginalStory, 'editor');
        
        document.getElementById('editorResponse').innerHTML = `
            <div class="character-name">üëΩ Zyx-9 from Kepler-442b says:</div>
            <p>${editorResponse}</p>
        `;
        
        // Show the kid's explanation for editing
        document.getElementById('editStory').value = currentOriginalStory;
        document.getElementById('editStory').placeholder = 'Improve your explanation based on Zyx-9\'s suggestions...';
        
        // Show revision buttons, hide researcher button
        document.getElementById('revisionButtons').style.display = 'block';
        document.getElementById('researcherButtons').style.display = 'none';
        document.getElementById('researcherSection').style.display = 'none';
        
        showNotification('üì° Zyx-9 wants to help improve your explanation!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Alien API Error:', error);
        alert(`The aliens are having communication issues: ${error.message}`);
        showPage('reviewPage');
    } finally {
        sendButton.disabled = false;
        sendButton.textContent = 'Send to Alien Researcher üëΩ';
    }
}
        
       async function submitRevision() {
    const revisedStory = document.getElementById('editStory').value.trim();
    
    if (!revisedStory) {
        alert('Please improve your explanation based on Zyx-9\'s suggestions!');
        return;
    }
    
    // Update the current story with the revision
    currentOriginalStory = revisedStory;
    
    showPage('waitingPage');
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Zyx-9 Reviewing Your Updates...';
    document.querySelector('#waitingPage p').textContent = 'Checking if your explanation is ready for the top researcher!';
    
    try {
        const feedback = await callGeminiAPI(revisedStory, 'revision');
        
        // Check if Zyx-9 thinks it's ready for the researcher
        if (feedback.toLowerCase().includes('excellent') || feedback.toLowerCase().includes('ready') || feedback.toLowerCase().includes('top researcher')) {
            // Ask for permission to send to researcher
            const approvalResponse = await callGeminiAPI(revisedStory, 'approve_for_researcher');
            
            document.getElementById('editorResponse').innerHTML = `
                <div class="character-name">üëΩ Zyx-9 says:</div>
                <p>${approvalResponse}</p>
            `;
            
            // Show the researcher approval buttons
            document.getElementById('revisionButtons').style.display = 'none';
            document.getElementById('researcherButtons').style.display = 'block';
            
        } else {
            // Continue improving the explanation
            document.getElementById('editorResponse').innerHTML = `
                <div class="character-name">üëΩ Zyx-9 responds:</div>
                <p>${feedback}</p>
            `;
            
            document.getElementById('editStory').value = revisedStory;
        }
        
        showNotification('üì° Zyx-9 responded!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Revision API Error:', error);
        alert(`Communication error with aliens: ${error.message}`);
        showPage('editorPage');
    }
        
        // Add this new function for generating the alien story
async function generateAlienStory() {
    showPage('waitingPage');
    
    // Update waiting page for story generation
    document.querySelector('#waitingPage h2').textContent = 'üëΩ Zyx-9 Writing Earth Story...';
    document.querySelector('#waitingPage p').textContent = 'The alien researcher is writing a complete story about what they learned!';
    
    try {
        const alienStoryResponse = await callGeminiAPI(currentOriginalStory, 'alien_story');
        currentAIStory = alienStoryResponse;
        
        // Update the editor page to show the alien story
        document.getElementById('editorResponse').innerHTML = `
            <div class="character-name">üëΩ Zyx-9's Complete Earth Story:</div>
            <div class="story-display" style="background: rgba(100, 255, 100, 0.1); border-left: 5px solid #00ff00;">
                <p>${alienStoryResponse}</p>
            </div>
            <p><strong>What do you think of Zyx-9's story? You can give feedback to help the aliens understand Earth better!</strong></p>
        `;
        
        // Update the textarea with the alien story for editing
        document.getElementById('editStory').value = alienStoryResponse;
        document.getElementById('editStory').placeholder = 'Give feedback to Zyx-9 about their Earth story...';
        
        // Show the feedback section
        showAlienStorySection();
        
        showNotification('üëΩ Zyx-9 wrote a complete story!');
        setTimeout(() => showPage('editorPage'), 2000);
        
    } catch (error) {
        console.error('Alien Story Error:', error);
        alert(`The aliens had trouble writing the story: ${error.message}`);
        showPage('editorPage');
    }
}
async function saveStoryAsIs() {
    const title = 'My Earth Explanation';
    const saved = await saveStory(title, currentOriginalStory, '');
    if (saved) {
        showPage('dashboardPage');
        loadDashboard();
    }
}

function finalizeStory() {
    showPage('successPage');
}
        async function saveFinishedStory() {
            const title = document.getElementById('storyTitle').value.trim() || 'My Story';
            const saved = await saveStory(title, currentOriginalStory, currentAIStory);
            if (saved) {
                showPage('dashboardPage');
                loadDashboard();
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.onclick = () => notification.remove();
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
        
// Updated API call function
async function callGeminiAPI(storyText, mode) {
    let prompt;
    if (mode === 'editor') {
        prompt = `You are Zyx-9, a friendly alien researcher from planet Kepler-442b. A human child is helping you understand Earth by explaining a video. Here's their explanation: "${storyText}"

Respond as Zyx-9 with:
1. Thank them for their explanation
2. Give 2-3 specific suggestions to make their explanation better/clearer
3. Ask 1-2 curious questions to help them add more detail
4. Keep it encouraging and under 80 words
5. Use friendly alien language

Focus on helping them improve THEIR explanation, not writing your own story yet.`;

    } else if (mode === 'approve_for_researcher') {
        prompt = `You are Zyx-9. The human child has written this excellent explanation: "${storyText}"

Respond as Zyx-9 with:
1. Praise their final explanation
2. Ask if you can send it to your top researcher, Dr. Qorinth, who writes detailed reports for the Galactic Earth Studies Department
3. Explain that Dr. Qorinth will write a complete research report based on their explanation
4. Keep it under 60 words and friendly`;

    } else if (mode === 'researcher_story') {
        prompt = `You are Dr. Qorinth, the top alien researcher at the Galactic Earth Studies Department. You've received this explanation about Earth from a human child: "${storyText}"

Write a detailed research report (300-500 words) that:
1. Analyzes what you learned about Earth culture/behavior from the child's explanation
2. Written in a formal but accessible research style for other aliens
3. Shows your alien perspective trying to understand human customs
4. Includes scientific observations about human behavior
5. Ends with conclusions about Earth society

Write as a complete research document, not a response to the child.`;

    } else if (mode === 'researcher_revision') {
        prompt = `You are Dr. Qorinth responding to feedback on your research report. 

Original human explanation: "${currentOriginalStory}"
Your research report: "${currentAIStory}"
Human child's feedback: "${storyText}"

Respond as Dr. Qorinth with:
1. Thank them for their valuable feedback
2. Explain how you'll revise the report based on their suggestions
3. Ask if they have any other insights about Earth customs
4. Keep it brief and professional but friendly (under 80 words)`;

    } else {
        // This is the regular revision mode for the kid's explanation
        prompt = `You are Zyx-9 responding to the human child's revised explanation: "${storyText}"

Original explanation: "${currentOriginalStory}"
Their revision: "${storyText}"

Give encouraging feedback on their improvements and either:
- Suggest one more small improvement, OR
- Say their explanation is excellent and ready for the top researcher

Keep it brief, encouraging, and under 60 words.`;
    }
    
    const requestBody = {
        contents: [{
            parts: [{ text: prompt }]
        }],
        generationConfig: {
            temperature: 0.8,
            maxOutputTokens: 500
        }
    };
    
    const response = await fetch('/api/editor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `Server error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
        throw new Error('Invalid response from AI service');
    }
    
    return data.candidates[0].content.parts[0].text;
}
        
        // Setup event listeners when page loads
        window.addEventListener('load', async () => {
            console.log("Setting up event listeners...");
            
            // Test server connection
            const statusElement = document.getElementById('connectionStatus');
            try {
                const response = await fetch('/health');
                const data = await response.json();
                console.log('‚úÖ Server connection OK:', data);
                statusElement.innerHTML = `<span style="color: #28a745;">‚úÖ Server Ready</span>`;
            } catch (error) {
                console.error('‚ùå Server connection failed:', error);
                statusElement.innerHTML = `<span style="color: #dc3545;">‚ùå Server Issue</span>`;
            }
            
            // Authentication event listeners
            document.getElementById('registerButton').addEventListener('click', registerUser);
            document.getElementById('loginButton').addEventListener('click', loginUser);
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // Navigation event listeners
            document.getElementById('newStoryButton').addEventListener('click', () => showPage('welcomePage'));
            document.getElementById('startButton').addEventListener('click', startStorySession);
            document.getElementById('backToDashboardButton').addEventListener('click', () => loadDashboard());
            document.getElementById('viewLibraryButton').addEventListener('click', () => loadDashboard());
            document.getElementById('createAnotherButton').addEventListener('click', () => showPage('welcomePage'));
            
            // Story flow event listeners
            document.getElementById('continueButton').addEventListener('click', continueVideo);
            document.getElementById('finishButton').addEventListener('click', finishStory);
            document.getElementById('sendToResearcherButton').addEventListener('click', sendToResearcher);
document.getElementById('declineResearcherButton').addEventListener('click', declineResearcher);
document.getElementById('submitResearcherFeedbackButton').addEventListener('click', submitResearcherFeedback);
document.getElementById('approveResearchButton').addEventListener('click', () => showPage('successPage'));
            document.getElementById('sendEditorButton').addEventListener('click', sendToEditor);
            document.getElementById('saveStoryButton').addEventListener('click', saveStoryAsIs);
            document.getElementById('submitRevisionButton').addEventListener('click', submitRevision);
            document.getElementById('finalizeButton').addEventListener('click', finalizeStory);
            document.getElementById('saveFinishedStoryButton').addEventListener('click', saveFinishedStory);

            
            // Allow Enter key to submit first name
            document.getElementById('firstNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerUser();
            });
            
            console.log("‚úÖ All event listeners ready!");
        });
        
        console.log("üé¨ Story Creator with Authentication loaded!");
        console.log('‚úÖ Script loaded completely!');
    </script>
</body>
</html>